## **Урок 10: Структурування наборів тестів і тестових випадків**

### **Цілі**
- Організувати тести з використанням найкращих практик для забезпечення підтримуваності та масштабованості.
- Використовувати команди Cypress для створення чистого, повторно використовуваного тестового коду.
- Реалізувати правильні процедури налаштування та очищення.
- Використовувати теги та конвенції іменування для категоризації тестів і вибіркового виконання.

---

### **Розбивка змісту**

#### **A. Організація тестів**
- **Використання блоків `describe()` та `it()`:**
  - **Блок `describe()`:**  
    Використовується для групування пов’язаних тестів у тестовий набір. Допомагає логічно організувати тести за функцією або можливістю.
    - **Приклад:**
      ```javascript
      describe('Login Functionality', () => {
        // Тут розташовуються тест-кейси, пов’язані з функціоналом входу.
      });
      ```
  - **Блок `it()`:**  
    Визначає окремий тестовий випадок, який перевіряє конкретну поведінку.
    - **Приклад:**
      ```javascript
      it('should successfully log in with valid credentials', () => {
        // Кроки тесту та твердження.
      });
      ```
- **Групування пов’язаних тестів:**
  - Організовуйте тести за маршрутами користувача (наприклад, вхід, реєстрація, дашборд) чи за функціональністю.
  - Використовуйте вкладені блоки `describe()` за потреби, щоб створити підгрупи для детальнішої організації.

##### **Приклад вкладених блоків describe()**

Вкладені блоки describe допомагають додатково групувати й організовувати тести, особливо при роботі зі складними маршрутами користувача або різними аспектами однієї функціональності.

**Приклад:**
```javascript
describe('User Account', () => {
  describe('Login Functionality', () => {
    it('should log in successfully with valid credentials', () => {
      // Логіка тесту для входу
    });

    it('should display an error with invalid credentials', () => {
      // Логіка тесту для помилкового входу
    });
  });

  describe('Registration Functionality', () => {
    it('should register a new user with valid details', () => {
      // Логіка тесту для реєстрації
    });

    it('should display errors for missing fields', () => {
      // Логіка тесту для перевірки валідації
    });
  });
});
```

##### **Коректні конвенції іменування блоків describe() та it()**

**Конвенції іменування** повинні бути чіткими, описовими та відповідати послідовному шаблону. Хороша практика — використовувати природну мову для опису того, що тестується, і очікуваного результату.

- **Імена блоків describe():**  
  Використовуйте іменник або назву функції, що чітко ідентифікує предмет тестування.
  
  **Приклади:**
  - `describe('Login Functionality', () => { ... })`
  - `describe('User Registration', () => { ... })`
  - `describe('Shopping Cart Operations', () => { ... })`

- **Імена блоків it():**  
  Використовуйте речення чи фразу, яка описує очікувану поведінку. За можливості застосовуйте шаблон Arrange-Act-Assert (AAA) для імен тестів.
  
  **Приклади:**
  - `it('should display the welcome message when login is successful', () => { ... })`
  - `it('should show an error when required fields are missing during registration', () => { ... })`
  - `it('should add an item to the cart and update the total price accordingly', () => { ... })`

##### **Використання AAA (Arrange-Act-Assert) у тестах та іменах тестів**

**Шаблон AAA:**  
AAA структурує тести на три чіткі фази:

- **Arrange:** Налаштуйте сценарій тесту, ініціалізуйте дані й підготуйте середовище.
- **Act:** Виконайте дію, яку необхідно протестувати.
- **Assert:** Переконайтесь, що результат відповідає очікуванню.

**В іменах тестів:**  
Додавання підказок AAA в імена тестів може прояснити наміри:
- **Приклад імені тесту:**  
  `it('arranges valid login data, acts by submitting the form, and asserts that the welcome message is displayed', () => { ... })`

**Приклад тесту зі структурою AAA:**
```javascript
it('should log in successfully with valid credentials', () => {
  // Arrange
  const validUsername = 'demoUser';
  const validPassword = 'demoPass';

  // Act
  cy.get('[data-testid="username-input"]').type(validUsername);
  cy.get('[data-testid="password-input"]').type(validPassword);
  cy.get('[data-testid="login-button"]').click();

  // Assert
  cy.get('[data-testid="login-success-message"]').should('be.visible');
});
```

#### **B. Методи налаштування та очищення (Setup and Teardown)**
- **Огляд хуків:**
  - **Хук `before()`:**  
    Виконується один раз перед усіма тестами в блоці `describe()`.
  - **Хук `beforeEach()`:**  
    Виконується перед кожним окремим тестом; корисно для скидання стану чи переходу на загальну стартову сторінку.
  - **Хук `after()`:**  
    Виконується один раз після всіх тестів у блоці `describe()`, найчастіше використовується для очищення.
  - **Хук `afterEach()`:**  
    Виконується після кожного тесту; корисно для скидання змін, зроблених під час тесту.
- **Практичне використання:**
  - **Передумови:**  
    Налаштування тестових даних або вхід користувача перед запуском тестів.
  - **Очищення:**  
    Скидання даних або очищення session storage, щоб гарантувати ізольованість тестів.
  - **Приклад:**
    ```javascript
    describe('User Login', () => {
      before(() => {
        // Виконується один раз перед усіма тестами
        cy.log('Starting Login Test Suite');
      });

      beforeEach(() => {
        // Перехід на сторінку входу перед кожним тестом
        cy.visit('/login');
      });

      afterEach(() => {
        // Очищення cookies чи локального сховища за потреби
        cy.clearCookies();
      });

      after(() => {
        cy.log('Login Test Suite completed');
      });
      
      it('should log in successfully with valid credentials', () => {
        // Код тесту
      });
    });
    ```

#### **C. Тегування та категоризація тестів**
- **Використання конвенцій іменування:**
  - Додавайте префікси або суфікси до назв тестів для позначення категорії (наприклад, `@smoke`, `@regression`, `@login`).
  - **Приклад:**
    ```javascript
    describe('User Login @smoke', () => { ... });
    ```
- **Плагіни Cypress для тегування:**
  - **Cypress-Grep:**  
    Використовуйте цей плагін для фільтрації тестів за тегами під час виконання.
    - **Встановлення:**  
      ```bash
      npm install cypress-grep --save-dev
      ```
    - **Використання:**  
      Запуск тестів з певним тегом:
      ```bash
      npx cypress run --env grep=@login
      ```
  - **Кастомне тегування:**  
    За потреби додайте коментарі або власні метадані для додаткової організації.

#### **D. Функціональність користувацьких команд Cypress**
- **Вбудовані команди Cypress:**
  - Такі команди як `cy.visit()`, `cy.get()`, `cy.click()`, `cy.type()` тощо використовуються для взаємодії із застосунком.
  - **Приклад:**
    ```javascript
    cy.visit('/login');
    cy.get('[data-testid="username-input"]').type('demoUser');
    cy.get('[data-testid="password-input"]').type('demoPass');
    cy.get('[data-testid="login-button"]').click();
    ```

- **Користувацькі команди:**

  ##### **Користувацькі команди Cypress**

  **Що таке користувацькі команди?**  
  Користувацькі команди в Cypress — це функції, які ви визначаєте (зазвичай у `cypress/support/commands.js`) для інкапсуляції повторюваних дій чи складної логіки. Вони допомагають скоротити дублювання, спростити код тестів і сприяють повторному використанню.

  **Переваги:**
  - **Повторне використання:**  
    Напишіть команду один раз і використовуйте її у кількох тестах.
  - **Зрозумілість:**  
    Користувацькі команди створюють вищий рівень абстракції, роблячи тести більш зрозумілими.
  - **Підтримуваність:**  
    Оновлення спільної функціональності проводиться лише в одному місці.

  **Недоліки:**
  - **Надмірна абстракція:**  
    Надмірне використання абстракцій може ускладнити налагодження тестів.
  - **Потенційно прихована логіка:**  
    Якщо команда містить занадто багато логіки, не завжди зрозуміло, що відбувається безпосередньо у тесті.

  **Приклад створення користувацьких команд:**

  У **cypress/support/commands.js**:
  ```javascript
  // Користувацька команда для входу
  Cypress.Commands.add('login', (username, password) => {
    cy.get('[data-testid="username-input"]').clear().type(username);
    cy.get('[data-testid="password-input"]').clear().type(password);
    cy.get('[data-testid="login-button"]').click();
  });

  // Користувацька команда для реєстрації нового користувача
  Cypress.Commands.add('registerUser', (user) => {
    cy.get('[data-testid="reg-username-input"]').clear().type(user.username);
    cy.get('[data-testid="reg-email-input"]').clear().type(user.email);
    cy.get('[data-testid="reg-password-input"]').clear().type(user.password);
    cy.get('[data-testid="reg-submit-button"]').click();
  });
  ```

  **Використання в тестах:**
  ```javascript
  describe('User Authentication', () => {
    it('should log in successfully', () => {
      // Використання користувацької команди логіну
      cy.login('demoUser', 'demoPass');
      cy.get('[data-testid="login-success-message"]').should('be.visible');
    });

    it('should register a new user', () => {
      const user = {
        username: 'newUser',
        email: 'newuser@example.com',
        password: 'newPassword123'
      };

      // Використання користувацької команди реєстрації
      cy.registerUser(user);
      cy.get('[data-testid="reg-success-message"]').should('be.visible');
    });
  });
  ```

  **Додаткові переваги користувацьких команд:**
  - **Інкапсуляція:**  
    Інкапсулюйте повторювані дії з UI, скорочуючи дублювання коду.
  - **Абстракція:**  
    Абстрагуйте низькорівневі команди Cypress, щоб зосередитися на вищій логіці тесту.
  - **Проста підтримка:**  
    Якщо в додатку стаються оновлення, змініть лише визначення команди, а не всі тести.

  - Розширюйте функціонал Cypress, додаючи користувацькі команди у файл `cypress/support/commands.js`.
  - **Приклад:**
    ```javascript
    // У cypress/support/commands.js
    Cypress.Commands.add('login', (username, password) => {
      cy.get('[data-testid="username-input"]').type(username);
      cy.get('[data-testid="password-input"]').type(password);
      cy.get('[data-testid="login-button"]').click();
    });
    // Використання у тестах:
    cy.login('demoUser', 'demoPass');
    ```
- **Найкращі практики:**
  - Зберігайте команди описовими та підтримуваними.
  - Використовуйте користувацькі команди для зменшення дублювання та централізації логіки.
  - Переконайтеся, що мета кожної команди зрозуміла для будь-кого, хто читає тест.

#### **E. Структура тестових проектів Cypress**

**Найкращі практики:**

- **Структура директорій:**
  - **cypress/fixtures:** Містить зовнішні файли даних (JSON тощо) для тестових даних.
  - **cypress/e2e:** Зберігає всі файли тест-специфікацій, організовані за функціями (наприклад, login.spec.js, registration.spec.js).
  - **cypress/plugins:** Містить плагіни чи модифікації поведінки Cypress за замовчуванням.
  - **cypress/support:**  
    - **commands.js:** Файл, де визначаються користувацькі команди.
    - **index.js:** Глобальна конфігурація та код налаштування для тестів Cypress.
  
- **Організація тестів:**
  - Групуйте тести по функціях або модулях за допомогою блоків `describe()`.
  - Для підфункцій використовуйте вкладені блоки `describe()`.
  - Дотримуйтеся послідовних конвенцій у найменуванні тестових файлів (наприклад, login.spec.js для тестів логіну).
  
- **Конфігурація середовища:**
  - Використовуйте файл конфігурації (cypress.config.js) для керування налаштуваннями, такими як baseUrl, таймаути та змінні середовища.
  - Розділяйте тести для різних середовищ за допомогою іменування файлів чи таких плагінів, як Cypress-grep.
  
- **Підтримуваність і повторне використання:**
  - Створюйте користувацькі команди для зменшення дублювання.
  - Використовуйте фікстури для винесення тестових даних, щоб тести були чистими і зосередженими.
  - Дотримуйтеся патерну AAA (Arrange-Act-Assert) для прозорості структури тесту.

- **Приклад структури директорій:**
  ```
  cypress/
  ├── fixtures/
  │   └── users.json
  ├── integration/
  │   ├── login.spec.js
  │   └── registration.spec.js
  ├── plugins/
  │   └── index.js
  └── support/
      ├── commands.js
      └── index.js
  ```
---

### **Практичні вправи**

1. **Структуруйте тести з `describe()` та `it()`:**
   - Створіть зразок набору тестів для функціоналу логіну.
   - Згрупуйте тести у окремі блоки (наприклад, успішний вхід, невдалий вхід).
   
2. **Реалізуйте хуки налаштування та очищення:**
   - Напишіть тести з використанням `before()`, `beforeEach()`, `after()`, `afterEach()` для керування станом тестування.
   - Приклад вправи: Записуйте повідомлення чи налаштовуйте умови (наприклад, перехід на сторінку логіну) перед кожним тестом.

3. **Тегуйте та фільтруйте тести:**
   - Використовуйте конвенції іменування чи теги (наприклад, `@smoke`, `@regression`) у заголовках тестів.
   - Налаштуйте та продемонструйте запуск тестів за допомогою плагіну Cypress-grep.
   
4. **Користувацькі команди:**
   - Створіть користувацьку команду (наприклад, `cy.login()`) і використовуйте її у кількох тест-кейсах.
   - Рефакторіть існуючий тестовий код на використання цієї кастомної команди.

---

### **Ресурси**

- **Документація Cypress:**
  - [Cypress Testing Structure](https://docs.cypress.io/guides/core-concepts/writing-and-organizing-tests)
  - [Cypress Commands](https://docs.cypress.io/api/commands)
- **Приклади тестових наборів:**
  - Шукайте приклади проектів на GitHub, що демонструють добре організовані тести Cypress.
- **Плагін Cypress-Grep:**
  - [Cypress-Grep GitHub Repository](https://github.com/cypress-io/cypress-grep)