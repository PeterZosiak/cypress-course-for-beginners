## **Урок 8: Обробка тверджень (assertions) та валідацій**

### **1. Зміст уроку**

#### **A. Вступ до тверджень**
- **Визначення:**
  - Твердження (assertions) — це оператори у тестовому коді, які перевіряють, чи справджується певна умова. Вони є критично важливими для підтвердження того, що стан застосунку відповідає очікуваним результатам.
- **Чому твердження важливі:**
  - **Виявлення помилок:** Допомагають швидко визначити, коли програма поводиться не так, як очікується.
  - **Надійність тестування:** Гарантують, що зміни у коді не ламають очікувану функціональність.
  - **Документація:** Служать своєрідною живою документацією того, як має працювати застосунок.

#### **B. Твердження Cypress та інтеграція з Chai**
- **Вбудовані твердження Cypress:**
  - Cypress використовує Chai як базу для своїх тверджень.
- **Стилі тверджень у Chai:**
  - **Should:** Ланцюгові твердження через `should()`.
  - **Expect:** Функціональний стиль за допомогою `expect()`.
  - **Assert:** Класичний стиль через `assert`.
- **Приклади:**
  - `cy.get(selector).should('be.visible')`
  - `expect(value).to.equal(expectedValue)`

**Визначення:**
Chai — це популярна бібліотека тверджень для JavaScript, що надає різноманітні стилі для написання тестів. Вона дозволяє розробникам писати зрозумілі, людиноподібні тести з чіткими і описовими твердженнями.

**Як використовувати Chai:**
- **Інтеграція з Cypress:**  
  Cypress вже містить Chai, тож ви можете використовувати його твердження напряму у тестах без додаткових налаштувань.
- **Поширені стилі тверджень у Chai:**
  - **Should стиль:**  
    Використовує ланцюгову мову, що читається як природна мова.
    ```javascript
    cy.get('[data-testid="login-button"]').should('be.visible');
    ```
  - **Expect стиль:**  
    Використання функцій для вираження очікувань.
    ```javascript
    cy.get('[data-testid="login-button"]').then(($btn) => {
      expect($btn).to.be.visible;
    });
    ```
  - **Assert стиль:**  
    Використання класичних функцій для тверджень.
    ```javascript
    cy.get('[data-testid="login-button"]').then(($btn) => {
      assert.isTrue($btn.is(':visible'), 'Login button is visible');
    });
    ```

    #### Найбільш поширені твердження у Cypress

    **1. `should('exist')`**
    Перевіряє, що елемент існує у DOM.

    ```javascript
    cy.get('[data-testid="login-button"]').should('exist');
    ```
    **Використовуйте, коли:** Ви хочете переконатися, що елемент відрендерений.
    ---

    **2. `should('be.visible')`**
    Перевіряє, що елемент **видимий** для користувача.

    ```javascript
    cy.get('[data-testid="modal"]').should('be.visible');
    ```
    **Використовуйте, коли:** Потрібно переконатися, що користувач бачить/може взаємодіяти з елементом.

    ---
    **3. `should('not.exist')`** / `should('not.be.visible')`  
    Протилежні до вище — гарно підходять для тестування **видалення або приховування** елементів.

    ```javascript
    cy.get('[data-testid="loading-spinner"]').should('not.exist');
    ```

    ---
    **4. `should('have.text', 'some text')`**
    Перевіряє **точний** вміст тексту усередині елемента.

    ```javascript
    cy.get('[data-testid="welcome-message"]').should('have.text', 'Welcome back!');
    ```

    **Альтернатива:**  
    Використовуйте `contains()` для часткового співпадіння, або `.should('include.text', 'Welcome')`.

    ---
    **5. `should('include.text', 'partial text')`**
    Перевіряє, чи містить елемент підрядок (не вимагається точний збіг).

    ```javascript
    cy.get('.alert').should('include.text', 'Error');
    ```
    
    ---
    **6. `should('have.value', 'text')`**
    Перевіряє значення полів вводу.

    ```javascript
    cy.get('[data-testid="email-input"]').should('have.value', 'user@example.com');
    ```

    **Використовуйте, коли:** Потрібно переконатися, що поле заповнене вірно.

    ---
    **7. `should('be.checked')` / `should('not.be.checked')`**
    Використовується для чекбоксів або радіокнопок.

    ```javascript
    cy.get('#terms-checkbox').should('be.checked');
    ```

    ---
    **8. `should('be.disabled')` / `should('be.enabled')`**
    Переконується, що елементи форми активні/неактивні як очікується.

    ```javascript
    cy.get('[data-testid="submit-btn"]').should('be.disabled');
    ```

    ---
    **9. `should('have.class', 'class-name')`**
    Перевіряє, чи застосований до елемента певний клас.

    ```javascript
    cy.get('button').should('have.class', 'active');
    ```

    ---
    **10. `should('have.attr', 'attribute', 'value')`**
    Перевіряє, чи є у елемента конкретний атрибут із певним значенням.

    ```javascript
    cy.get('a').should('have.attr', 'href', '/dashboard');
    ```

    Також корисно для перевірки наявності атрибутів `data-*`, `target`, `src`, `disabled` тощо.

    ----
    **11. `should('have.length', number)`**
    Перевіряє, скільки елементів повернув `cy.get()`.

    ```javascript
    cy.get('.list-item').should('have.length', 5);
    ```

    **Використовуйте, коли:** Потрібно перевірити, що список містить очікувану кількість елементів.

    ---
    **12. `should('match', /regex/)`**
    Перевіряє, що рядок відповідає регулярному виразу.

    ```javascript
    cy.get('[data-testid="email"]').invoke('text').should('match', /^[^\s@]+@[^\s@]+\.[^\s@]+$/);
    ```


    Використовуйте `expect()` всередині блоку `.then()`, коли працюєте з логікою чи кастомнимі даними:

    ```javascript
    cy.get('#price').then(($el) => {
      const price = parseFloat($el.text().replace('€', ''));
      expect(price).to.be.lessThan(100);
    });
    ```


- **Should стиль:**  
  - **Переваги:**  
    - Дуже читабельно та виразно (наприклад, `should('be.visible')`).
    - Підтримує ланцюжковість декількох тверджень у природній формі.
    - Автоматично повторює твердження при використанні з командами Cypress.
  - **Недоліки:**  
    - Потребує розширення прототипів об’єктів, що може не підходити у всіх оточеннях.
- **Expect стиль:**  
  - **Переваги:**  
    - Зрозумілий синтаксис на основі функцій, знайомий багатьом розробникам.
    - Не потребує розширення прототипів.
  - **Недоліки:**  
    - Не повторює твердження автоматично, оскільки зазвичай використовується всередині `.then()`.
- **Assert стиль:**  
  - **Переваги:**  
    - Більш традиційний та простий, схожий на твердження в інших мовах.
  - **Недоліки:**  
    - Менш читабельний та потребує більше шаблонного коду.


#### **C. Поширені методи тверджень у Cypress**
- **Видимість та існування:**
  - `should('be.visible')`, `should('exist')`, `should('not.exist')`
- **Перевірка вмісту:**
  - `should('have.text', 'expected text')`
  - `should('contain', 'partial text')`
- **Перевірка атрибутів:**
  - `should('have.attr', 'attributeName', 'value')`
- **Перевірка CSS та стилю:**
  - `should('have.css', 'property', 'value')`
- **Перевірка стану:**
  - `should('be.disabled')`, `should('be.enabled')`, `should('be.checked')`

#### **D. Розширені твердження**
- **Кілька тверджень:**
  - Ланцюгуйте декілька команд `should()` для комплексної перевірки.
  - Приклад: перевірити, що елемент видимий і містить певний текст.
- **Умовні твердження:**
  - Використовуйте `.then()`, щоб виконати твердження за динамічного контенту чи стану.
- **Кастомні твердження:**
  - Визначайте власну логіку твердження, коли стандартних недостатньо.


##### **Каскадні та групові твердження**

**Каскадні твердження з `should()`:**
- **Приклад:**
  ```javascript
  cy.get('[data-testid="username-input"]')
    .should('be.visible')
    .and('have.attr', 'placeholder', 'Enter your username')
    .and(($input) => {
      // Кастомна перевірка: поле за замовчуванням пусте
      expect($input.val()).to.equal('');
    });
  ```
- **Пояснення:**  
  Ланцюжок вище:
  - Перевіряє, що елемент видимий.
  - Перевіряє, що атрибут placeholder має очікуване значення.
  - Виконує кастомну перевірку, що значення інпуту порожнє.
  
**Кілька тверджень у команді:**
- Використання декількох викликів `should()` або ланцюгування з `and()` дозволяє затвердити декілька умов для одного елемента без повторного запиту DOM, що ефективно та підвищує читабельність.


### **Чому краще використовувати `should()` замість `expect()` у Cypress**

- **Механізм повторної перевірки (auto-retry):**
  - **`should()`** інтегрований з механізмом повторів Cypress. Якщо твердження не проходить відразу (наприклад, елемент ще завантажується), Cypress автоматично повторюватиме твердження, поки воно не спрацює або не закінчиться тайм-аут.
  - **`expect()`** використовується в `.then()`-блоках і виконується лише один раз. Якщо елемент у цей момент не відповідає очікуванням, тест одразу падає.
  
- **Можливість ланцюжків:**
  - `should()` дозволяє ланцюжити декілька тверджень над одним об’єктом, знижуючи кількість повторних запитів до DOM та роблячи тести коротшими.
  
- **Читабельність:**
  - Плавний, природний стиль `should()` робить тести легкими для сприйняття й розуміння.

- **Уніфікація з командами Cypress:**
  - Використання `should()` напряму із командами Cypress дозволяє безшовно інтегрувати твердження у командну чергу Cypress.

**Порівняння прикладів:**

Використання **`should()`** (рекомендовано):
```javascript
cy.get('[data-testid="submit-button"]')
  .should('be.visible')
  .and('not.be.disabled');
```

Використання **`expect()`** (менш бажане у Cypress):
```javascript
cy.get('[data-testid="submit-button"]').then(($btn) => {
  expect($btn).to.be.visible;
  expect($btn).to.not.be.disabled;
});
```
- У другому прикладі, якщо кнопка не видима одразу, тест завершиться помилкою без повторів.


#### **E. Найкращі практики для тверджень та валідацій**
- **Чіткі та описові твердження:**
  - Пишіть твердження, які чітко пояснюють, що саме перевіряється.
  - Використовуйте кастомні повідомлення чи додатковий лог при потребі.
  - Формулюйте твердження, які відображають ваші очікування.  
     _Приклад:_  
     ```javascript
     cy.get('[data-testid="error-message"]')
       .should('be.visible')
       .and('contain', 'Invalid credentials');
     ```
   - Уникайте двозначних чи занадто складних тверджень, які поєднують кілька перевірок без явного розділення.

- **Гранульоване тестування:**
  - По змозі тестуйте одну умову на одне твердження, це допоможе швидше знаходити причину збоїв.
  - Віддайте перевагу одному твердженню на перевірку, але коли умови пов’язані (наприклад, видимість і зміст елемента), використовуйте ланцюжки з `should()`.
- **Уникайте перекриття тверджень:**
  - Переконайтеся, що твердження логічно поділені — це не дасть заплутатись під час дебагу.
  - Не затверджуйте одну й ту ж умову різними способами в одному кроці; для кожного твердження має бути окрема мета.

- **Використовуйте повторюваність Cypress:**
  - Cypress автоматично повторює твердження до успіху або тайм-ауту, тож пишіть твердження стійкі до тимчасових затримок.
- **Коректно використовуйте ланцюжки:**
  - Ланцюжіть твердження для зменшення дублювання та покращення читабельності.

---

### **2. Приклади коду**

#### **A. Базові твердження з використанням `should`**

```javascript
// Перевірити, що кнопка логіну видима і активна
cy.get('[data-testid="login-button"]')
  .should('be.visible')
  .and('not.be.disabled');
```

#### **B. Перевірка текстового вмісту**

```javascript
// Перевірити, чи повідомлення про успіх містить очікуваний текст
cy.get('[data-testid="success-message"]')
  .should('be.visible')
  .and('contain', 'Login successful');
```

#### **C. Перевірка атрибутів елементу**

```javascript
// Перевірити, що зображення має правильний атрибут src
cy.get('[data-testid="hero-image"]')
  .should('have.attr', 'src', 'images/hero.jpg');
```

#### **D. Твердження через `expect`**

```javascript
// Використання expect для перевірки змінної
cy.get('[data-testid="user-count"]').then(($count) => {
  const countText = $count.text();
  expect(parseInt(countText)).to.be.greaterThan(0);
});
```

#### **E. Ланцюгування декількох тверджень**

```javascript
// Ланцюжити твердження, щоб перевірити кілька умов для поля вводу
cy.get('[data-testid="username-input"]')
  .should('be.visible')
  .and('have.attr', 'placeholder', 'Enter your username')
  .and(($input) => {
    // Кастомне твердження: після введення поле не порожнє
    expect($input.val()).to.not.be.empty;
  });
```

#### **F. Умовні твердження з `.then()`**

```javascript
// Використовувати .then() для умовних перевірок динамічного контенту
cy.get('[data-testid="error-message"]').then(($el) => {
  if ($el.is(':visible')) {
    expect($el).to.contain('Invalid credentials');
  } else {
    cy.log('Error message not visible, test may have passed.');
  }
});
```

---

### **3. Потенційні питання студентів**

1. **Яка різниця між `should` та `expect` у Cypress?**
   - **Відповідь:**  
     `should()` — це ланцюжкова команда, яка автоматично повторює перевірки до позитивного результату, а `expect()` використовується для одноразових перевірок у середені `.then()`.

2. **Як Cypress обробляє твердження, якщо елементи завантажуються з затримкою?**
   - **Відповідь:**  
     Cypress автоматично повторює твердження до проходження перевірки або до закінчення тайм-ауту, що дозволяє безпечно працювати з асинхронними елементами.

3. **Чи можу я писати кастомні твердження у Cypress?**
   - **Відповідь:**  
     Так, ви можете писати власну логіку перевірок у блоках `.then()` для складніших сценаріїв.

4. **Чому варто уникати перекриття тверджень?**
   - **Відповідь:**  
     Перекриття ускладнює пошук причини падіння тесту. Краще розділяти перевірки для спрощення дебагу й підтримки.

5. **Що буде, якщо твердження не проходить?**
   - **Відповідь:**  
     Cypress припинить виконання тесту й виведе помилку з деталями, скріншотами і логами для дебагу.

---

### **4. Додаткові рекомендації**

- **Інтерактивне налагодження:**
  - Рекомендуйте студентам користуватися інтерактивним тестовим раннером Cypress, щоб побачити, як твердження повторюються.
- **Групові вправи:**
  - Об’єднуйте студентів у пари для написання тест-кейсів із кількома твердженнями та обговорення логіки кожного.
- **Опрацювання документації:**
  - Попросіть вивчити [Cypress Assertions Documentation](https://docs.cypress.io/guides/references/assertions) для подальшого поглиблення знань.