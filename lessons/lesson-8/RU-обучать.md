## **Урок 8: Работа с утверждениями и валидациями**

### **1. Структура содержания**

#### **A. Введение в утверждения (Assertions)**
- **Определение:**
  - Утверждения — это операторы в тестовом коде, проверяющие истинность определённого условия. Они критичны для проверки, соответствует ли состояние приложения ожидаемым результатам.
- **Почему утверждения важны:**
  - **Обнаружение ошибок:** Помогают быстро выявить, когда приложение ведёт себя не так, как ожидалось.
  - **Надёжность тестов:** Гарантируют, что изменения в коде не нарушают ожидаемую функциональность.
  - **Документация:** Являются живой документацией того, как должно работать приложение.

#### **B. Утверждения в Cypress и интеграция Chai**
- **Встроенные утверждения Cypress:**
  - Cypress использует Chai для утверждений.
- **Стилевые подходы к утверждениям в Chai:**
  - **Should:** Цепочные утверждения с помощью `should()`.
  - **Expect:** Функциональный стиль с помощью `expect()`.
  - **Assert:** Классический стиль с помощью `assert`.
- **Примеры:**
  - `cy.get(selector).should('be.visible')`
  - `expect(value).to.equal(expectedValue)`

**Определение:**
Chai — это популярная библиотека утверждений для JavaScript, предоставляющая различные стили написания тестов. Она позволяет разработчикам писать читаемые тесты с понятными и наглядными утверждениями.

**Как использовать Chai:**
- **Интеграция с Cypress:**  
  Cypress включает Chai «из коробки», поэтому его утверждения можно использовать напрямую в тестах без дополнительной настройки.
- **Основные стили утверждений в Chai:**
  - **Should-стиль:**  
    Использует цепочный синтаксис для построения утверждений, читающихся как естественный язык.
    ```javascript
    cy.get('[data-testid="login-button"]').should('be.visible');
    ```
  - **Expect-стиль:**  
    Использует вызовы функций для выражения ожиданий.
    ```javascript
    cy.get('[data-testid="login-button"]').then(($btn) => {
      expect($btn).to.be.visible;
    });
    ```
  - **Assert-стиль:**  
    Использует классические функции утверждений.
    ```javascript
    cy.get('[data-testid="login-button"]').then(($btn) => {
      assert.isTrue($btn.is(':visible'), 'Login button is visible');
    });
    ```

    #### Наиболее часто используемые утверждения в Cypress

    **1. `should('exist')`**
    Проверяет, что элемент существует в DOM.

    ```javascript
    cy.get('[data-testid="login-button"]').should('exist');
    ```
    **Используйте, когда:** Необходимо убедиться, что элемент был отрисован.
    ---

    **2. `should('be.visible')`**
    Проверяет, что элемент **видим** для пользователя.

    ```javascript
    cy.get('[data-testid="modal"]').should('be.visible');
    ```
    **Используйте, когда:** Нужно убедиться, что пользователь может увидеть/взаимодействовать с элементом.

    ---
    **3. `should('not.exist')`** / `should('not.be.visible')`  
    Противоположные проверки — отлично для проверки **удаления или скрытия** элементов.

    ```javascript
    cy.get('[data-testid="loading-spinner"]').should('not.exist');
    ```

    ---
    **4. `should('have.text', 'some text')`**
    Проверяет **точное** текстовое содержимое элемента.

    ```javascript
    cy.get('[data-testid="welcome-message"]').should('have.text', 'Welcome back!');
    ```

    **Альтернатива:**  
    Используйте `contains()` для частичного совпадения или `.should('include.text', 'Welcome')`.

    ---
    **5. `should('include.text', 'partial text')`**
    Проверяет, что элемент содержит подстроку (нет требования к точному совпадению).

    ```javascript
    cy.get('.alert').should('include.text', 'Error');
    ```
    
    ---
    **6. `should('have.value', 'text')`**
    Проверяет значение поля ввода.

    ```javascript
    cy.get('[data-testid="email-input"]').should('have.value', 'user@example.com');
    ```

    **Используйте, когда:** Нужно подтвердить, что поле заполнено корректно.

    ---
    **7. `should('be.checked')` / `should('not.be.checked')`**
    Используется для чекбоксов или радио-кнопок.

    ```javascript
    cy.get('#terms-checkbox').should('be.checked');
    ```

    ---
    **8. `should('be.disabled')` / `should('be.enabled')`**
    Проверяет, что элементы формы активны/неактивны, как ожидается.

    ```javascript
    cy.get('[data-testid="submit-btn"]').should('be.disabled');
    ```

    ---
    **9. `should('have.class', 'class-name')`**
    Проверяет, что у элемента есть определённый класс.

    ```javascript
    cy.get('button').should('have.class', 'active');
    ```

    ---
    **10. `should('have.attr', 'attribute', 'value')`**
    Проверяет, что у элемента есть определённый атрибут с конкретным значением.

    ```javascript
    cy.get('a').should('have.attr', 'href', '/dashboard');
    ```

    Также полезно для проверки наличия атрибутов `data-*`, `target`, `src`, `disabled` и др.

    ----
    **11. `should('have.length', number)`**
    Проверяет, сколько элементов вернул `cy.get()`.

    ```javascript
    cy.get('.list-item').should('have.length', 5);
    ```

    **Используйте, когда:** Нужно убедиться, что список содержит ожидаемое количество элементов.

    ---
    **12. `should('match', /regex/)`**
    Проверяет, что строка соответствует регулярному выражению.

    ```javascript
    cy.get('[data-testid="email"]').invoke('text').should('match', /^[^\s@]+@[^\s@]+\.[^\s@]+$/);
    ```


    Используйте `expect()` внутри блока `.then()` для работы с логикой или пользовательскими данными:

    ```javascript
    cy.get('#price').then(($el) => {
      const price = parseFloat($el.text().replace('€', ''));
      expect(price).to.be.lessThan(100);
    });
    ```


- **Should-стиль:**  
  - **Плюсы:**  
    - Очень читаемый и выразительный (например, `should('be.visible')`).
    - Поддерживает цепочку нескольких утверждений в естественном, плавном синтаксисе.
    - Автоматически повторяет утверждения при использовании с командами Cypress.
  - **Минусы:**  
    - Расширяет прототипы объектов, что может быть нежелательно в некоторых средах.
- **Expect-стиль:**  
  - **Плюсы:**  
    - Ясный синтаксис на основе функций, знакомый многим разработчикам.
    - Нет необходимости расширять прототипы.
  - **Минусы:**  
    - Не повторяет утверждения автоматически при использовании с Cypress-командами, так как обычно используется внутри `.then()`-колбэка.
- **Assert-стиль:**  
  - **Плюсы:**  
    - Более традиционный и прямолинейный, похожий на утверждения в других языках.
  - **Минусы:**  
    - Может быть менее читаемым и требует больше шаблонного кода.


#### **C. Общие методы утверждений в Cypress**
- **Проверка видимости и существования:**
  - `should('be.visible')`, `should('exist')`, `should('not.exist')`
- **Валидация содержимого:**
  - `should('have.text', 'expected text')`
  - `should('contain', 'partial text')`
- **Проверка атрибутов:**
  - `should('have.attr', 'attributeName', 'value')`
- **Проверка CSS и свойств стиля:**
  - `should('have.css', 'property', 'value')`
- **Проверка состояния:**
  - `should('be.disabled')`, `should('be.enabled')`, `should('be.checked')`

#### **D. Расширенные утверждения**
- **Множественные утверждения:**
  - Цепочка нескольких команд `should()` для комплексной проверки.
  - Пример: Проверка, что элемент видим и содержит определённый текст.
- **Условные утверждения:**
  - Используйте `.then()` для утверждений на основе динамического содержимого или условий.
- **Пользовательские утверждения:**
  - Определяйте собственную логику утверждения если стандартных недостаточно.


##### **Множественные утверждения и цепочка утверждений**

**Цепочка утверждений с помощью `should()`:**
- **Пример:**
  ```javascript
  cy.get('[data-testid="username-input"]')
    .should('be.visible')
    .and('have.attr', 'placeholder', 'Enter your username')
    .and(($input) => {
      // Пользовательская проверка: поле по умолчанию должно быть пустым
      expect($input.val()).to.equal('');
    });
  ```
- **Объяснение:**  
  Эта цепочка:
  - Проверяет, что элемент видим.
  - Проверяет, что атрибут placeholder имеет ожидаемое значение.
  - Выполняет пользовательское утверждение для проверки, что поле ввода пустое.
  
**Множественные утверждения в одной команде:**
- Использование нескольких вызовов `should()` или цепочки с помощью `and()` позволяет проверить несколько условий для одного элемента без повторного запроса к DOM, что эффективно и улучшает читаемость.


### **Почему использовать `should()`, а не `expect()` в Cypress**

- **Механизм автоповтора:**
  - **`should()`** интегрирован с механизмом ретрая Cypress. Если утверждение изначально не проходит из-за временного состояния (например, элемент загружается асинхронно), Cypress автоматически повторяет утверждение до успеха или достижения таймаута.
  - **`expect()`** используется внутри блоков `.then()`, то есть выполняется только один раз. Если элемент в этот момент не в ожидаемом состоянии, тест сразу завершится с ошибкой.
  
- **Цепочность:**
  - `should()` позволяет объединять несколько утверждений для одного объекта, уменьшая количество запросов к DOM и делая тесты более лаконичными.
  
- **Читаемость:**
  - Плавный, естественный язык `should()` делает утверждения легко читаемыми и понятными с первого взгляда.

- **Согласованность с Cypress-командами:**
  - Использование `should()` непосредственно с Cypress-командами бесшовно интегрируется с очередью команд Cypress, что гарантирует ретрая вместе с выполнением команд.

**Сравнение примеров:**

Использование **`should()`** (предпочтительно):
```javascript
cy.get('[data-testid="submit-button"]')
  .should('be.visible')
  .and('not.be.disabled');
```

Использование **`expect()`** (менее желательно в контексте Cypress):
```javascript
cy.get('[data-testid="submit-button"]').then(($btn) => {
  expect($btn).to.be.visible;
  expect($btn).to.not.be.disabled;
});
```
- Во втором примере, если кнопка не появится сразу, тест завершится неудачей без повторных проверок.


#### **E. Практики по написанию утверждений и валидаций**
- **Читаемые и наглядные утверждения:**
  - Пишите утверждения с чётким описанием того, что они проверяют.
  - При необходимости используйте пользовательские сообщения или дополнительный логинг.
  - Формулируйте утверждения так, чтобы было понятно, что именно вы ожидаете.  
     _Пример:_  
     ```javascript
     cy.get('[data-testid="error-message"]')
       .should('be.visible')
       .and('contain', 'Invalid credentials');
     ```
   - Избегайте неоднозначных или слишком сложных утверждений, объединяющих несколько проверок без чёткого разделения.

- **Детализированное тестирование:**
  - Проверяйте по одному условию на каждое утверждение, если это возможно. Так проще локализовать ошибки.
  - Предпочитайте проверять по одному условию на утверждение, чтобы изолировать проблемы.  
     Однако, если условия связаны (например, видимость и содержимое), то логично объединять их через цепочку `should()`.
- **Избегайте перекрывающихся утверждений:**
  - Разделяйте утверждения логически, чтобы упростить отладку при ошибках.
  - Не проверяйте одно и то же условие разными утверждениями в одном тестовом шаге; давайте каждой проверке уникальную цель.

- **Используйте ретрай Cypress:**
  - Cypress автоматически повторяет проверки до успеха или таймаута, поэтому пишите устойчивые к временному асинхронному поведению утверждения.
- **Правильное объединение утверждений:**
  - Объединяйте утверждения для сокращения избыточности кода и улучшения читаемости.

---

### **2. Примеры кода**

#### **A. Базовые утверждения с использованием `should`**

```javascript
// Проверить, что кнопка входа видима и активна
cy.get('[data-testid="login-button"]')
  .should('be.visible')
  .and('not.be.disabled');
```

#### **B. Проверка текстового содержимого**

```javascript
// Проверить, что сообщение об успехе содержит ожидаемый текст
cy.get('[data-testid="success-message"]')
  .should('be.visible')
  .and('contain', 'Login successful');
```

#### **C. Проверка атрибутов элемента**

```javascript
// Проверить, что у изображений есть правильный src
cy.get('[data-testid="hero-image"]')
  .should('have.attr', 'src', 'images/hero.jpg');
```

#### **D. Использование `expect` для утверждений**

```javascript
// Использование expect для проверок на переменных
cy.get('[data-testid="user-count"]').then(($count) => {
  const countText = $count.text();
  expect(parseInt(countText)).to.be.greaterThan(0);
});
```

#### **E. Объединение нескольких утверждений**

```javascript
// Цепочка утверждений для проверки нескольких условий поля ввода
cy.get('[data-testid="username-input"]')
  .should('be.visible')
  .and('have.attr', 'placeholder', 'Enter your username')
  .and(($input) => {
    // Пользовательская проверка: поле не пустое после ввода
    expect($input.val()).to.not.be.empty;
  });
```

#### **F. Условные утверждения с использованием `.then()`**

```javascript
// Использование .then() для условной проверки динамического содержимого
cy.get('[data-testid="error-message"]').then(($el) => {
  if ($el.is(':visible')) {
    expect($el).to.contain('Invalid credentials');
  } else {
    cy.log('Сообщение об ошибке не видно, возможно тест успешно прошел.');
  }
});
```

---

### **3. Возможные вопросы студентов**

1. **В чём разница между `should` и `expect` в Cypress?**
   - **Ответ:**  
     `should()` — цепочная команда, автоматически повторяющаяся до успеха утверждения, тогда как `expect()` используется для разовых проверок внутри блока `.then()`.

2. **Как Cypress обрабатывает утверждения, если элементы загружаются с задержкой?**
   - **Ответ:**  
     Cypress автоматически повторяет утверждения до их успеха или до достижения таймаута, что позволяет корректно работать с асинхронно загружаемыми элементами.

3. **Можно ли писать пользовательские утверждения в Cypress?**
   - **Ответ:**  
     Да, можно писать пользовательские проверки внутри блоков `.then()` для сложных сценариев валидации.

4. **Почему следует избегать перекрывающихся утверждений?**
   - **Ответ:**  
     Перекрывающиеся утверждения усложняют поиск источника ошибки. Чёткая изоляция облегчает отладку и сопровождение тестов.

5. **Что происходит, если утверждение не проходит?**
   - **Ответ:**  
     Cypress прекращает выполнение теста и выводит ошибку, предоставляя снимки и логи для отладки.

---

### **4. Дополнительные рекомендации**

- **Интерактивная отладка:**
  - Поощряйте студентов использовать интерактивный Test Runner Cypress для наблюдения за повторными проверками утверждений.
- **Групповые упражнения:**
  - Объединяйте студентов в пары для написания тестов с несколькими утверждениями и обсуждения логики каждой проверки.
- **Изучение документации:**
  - Рекомендуйте студентам ознакомиться с [документацией по утверждениям Cypress](https://docs.cypress.io/guides/references/assertions) для повышения квалификации.
