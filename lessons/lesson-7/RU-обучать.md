### **Урок 7: Взаимодействие с веб-элементами и обработка пользовательского ввода**

## **1. Структура содержания**

### **A. Введение**
- **Почему взаимодействие с веб-элементами важно:**
  - Проверяет, как пользователи взаимодействуют с элементами, такими как кнопки, поля ввода, чекбоксы, выпадающие списки и др.
  - Гарантирует, что веб-приложения ведут себя ожидаемым образом в ответ на пользовательский ввод.

##### Почему взаимодействие с веб-элементами важно

**Пояснение:**
- **Имитация работы в реальном мире:**  
  Взаимодействие с веб-элементами имитирует, как настоящие пользователи работают с веб-приложением. Автоматизированные тесты, повторяющие клики, набор текста и другие действия, помогают убедиться, что интерфейс правильно реагирует в каждой ситуации.

- **Проверка поведения интерфейса:**  
  Это подтверждает, что пользовательские действия (например, отправка формы, выбор опции или вызов модального окна) приводят к ожидаемым изменениям в DOM, таким как отображение сообщений об ошибках, обновление содержимого или переход на другую страницу.

- **Выявление регрессионных ошибок:**  
  Автоматические взаимодействия позволяют быстро выявлять регрессии интерфейса. Если разработчик изменил работу кнопки, тесты на взаимодействие тут же укажут на проблему.

- **Сквозное (E2E) тестирование:**  
  Тестирование взаимодействия критически важно для End-to-End (E2E) тестов, где проверяется полный путь пользователя — от загрузки страницы до последовательности действий и наблюдения за результатами.

### **B. Выбор элементов в Cypress**
- **CSS-селекторы (Основная методология):**
  - Базовые селекторы: `.class`, `#id`, `tag`.
  - Сложные селекторы: `div > button`, `input[type="text"]`.
- **Использование атрибутов `data-*`:**
  - Рекомендованная практика для стабильных селекторов в автоматизации:
    ```javascript
    cy.get('[data-testid="login-button"]');
    ```
- **Методы навигации:**
  - Поиск дочерних элементов: `cy.get('div').find('button')`.
  - Перемещение по структуре DOM: `.parent()`, `.children()`, `.next()`, `.prev()`.
- **Лучшие практики:**
  - Используйте `data-*` атрибуты для устойчивости тестов.
  - Избегайте ненадежных селекторов, таких как `nth-child`.

  ##### cy.get() vs cy.find()
  **Ключевое отличие:**  
  Используйте `cy.get()` для поиска по всему глобальному DOM. Применяйте `cy.find()`, чтобы сузить поиск внутри определённого контейнера или контекста.

  **cy.get():**
  - **Применение:**  
    `cy.get()` используется для выбора элементов из всего DOM по заданному селектору.
  - **Пример:**
    ```javascript
    // Выбирает элемент с атрибутом data-testid на всей странице
    cy.get('[data-testid="login-form"]');
    ```

  **cy.find():**
  - **Применение:**  
    `cy.find()` используется для поиска дочерних элементов внутри ранее выбранного элемента.
  - **Пример:**
    ```javascript
    // Сначала выбрать родительский элемент
    cy.get('[data-testid="login-form"]')
      // Затем найти дочерний input внутри этой формы
      .find('[data-testid="username-input"]');
    ```

##### Почему атрибут `data-testid` лучше, чем селекторы по ID или CLASS

**Пояснение:**
- **Стабильность при изменениях UI:**  
  Атрибуты `data-testid` используются исключительно для тестирования. Обычно они не затрагиваются редизайном или рефакторингом, в отличие от id или классов, которые могут меняться из-за дизайн-требований.

- **Разделение ответственности:**  
  Вынос тестовых селекторов отдельно от стилевых или структурных обеспечивает устойчивость тестов к визуальным изменениям.

- **Описательность и прозрачность намерений:**  
  Явно понятно, что атрибут используется для тестирования (например, `data-testid="login-button"`), что облегчает чтение и поддержку тестов.

- **Избежание конфликтов:**  
  ID и классы обычно применяются для стилей и верстки, поэтому их использование в тестах может приводить к конфликтам или непредсказуемому поведению при перераспределении селекторов.

**Пример:**
```html
<!-- Использование data-testid для тестирования -->
<button data-testid="submit-button">Submit</button>
```
```javascript
// Тест Cypress с использованием data-testid
cy.get('[data-testid="submit-button"]').click();
```

---

### **C. Действия с веб-элементами**
1. **Клик по элементам:**
   - Используйте `cy.click()` для имитации клика.
   - Пример:
     ```javascript
     cy.get('[data-testid="submit-button"]').click();
     ```

2. **Ввод текста в поля:**
   - Применяйте `cy.type()` для имитации ввода с клавиатуры.
   - Пример:
     ```javascript
     cy.get('[data-testid="username-input"]').type('testUser');
     ```
    - **Имитация событий клавиатуры:**
      - Используйте `.type()` с особыми клавишами, например `{enter}`, `{backspace}`.
      - Пример:
        ```javascript
        cy.get('[data-testid="search-input"]').type('Cypress{enter}');
        ```

3. **Очистка полей ввода:**
   - Используйте `.clear()` для удаления содержимого.
   - Пример:
     ```javascript
     cy.get('[data-testid="username-input"]').clear();
     ```

4. **Выбор опций из выпадающих списков:**
   - Используйте `.select()` для элементов `<select>`.
   - Пример:
     ```javascript
     cy.get('[data-testid="dropdown"]').select('Option 1');
     ```

5. **Чекбоксы и радиокнопки:**
   - `.check()` для выбора, `.uncheck()` для снятия чекбокса.
   - Пример:
     ```javascript
     cy.get('[data-testid="accept-terms"]').check();
     ```

6. **Отправка форм:**
   - Используйте `.submit()` для имитации отправки формы.
   - Пример:
     ```javascript
     cy.get('[data-testid="login-form"]').submit();
     ```

7. **Наведение курсора (hover):**
   - В Cypress нет отдельного метода для hover; используйте `.trigger('mouseover')`.
   - Пример:
     ```javascript
     cy.get('[data-testid="menu-item"]').trigger('mouseover');
     ```
---

### **D. Проверка взаимодействий**
- **Утверждения (Assertions):**
  - Подтверждают, что действия привели к ожидаемому состоянию или поведению.
  - Пример:
    ```javascript
    cy.get('[data-testid="success-message"]')
      .should('be.visible')
      .and('contain', 'Login Successful!');
    ```
- **Цепочки команд:**
  - Объединяйте действия и проверки для ясных, лаконичных тестов.
  - Пример:
    ```javascript
    cy.get('[data-testid="submit-button"]')
      .click()
      .get('[data-testid="error-message"]')
      .should('be.visible')
      .and('contain', 'Invalid credentials');
    ```

---

### **E. Продвинутая работа с вводом**
- **Загрузка файлов:**
  - Используйте `cy.selectFile()` для элементов выбора файла.
  - Пример:
    ```javascript
    cy.get('[data-testid="file-upload"]').selectFile('cypress/fixtures/sample.pdf');
    ```

- **Взаимодействие с неактивными элементами:**
  - Проверяйте или вызывайте события на неактивных (disabled) элементах:
    ```javascript
    cy.get('[data-testid="submit-button"]').should('be.disabled');
    ```

##### cy.trigger()

**Пояснение:**
- **Назначение:**  
  `cy.trigger()` применяется для имитации событий, для которых нет отдельных команд Cypress (например, `mouseover`, `keydown` и др.). Это полезно при тестировании реакции элементов на нестандартные или сложные взаимодействия.

- **Пример:**
  ```javascript
  // Вызов события mouseover на элементе
  cy.get('[data-testid="menu-item"]').trigger('mouseover');
  ```

- **Когда использовать:**  
  Используйте `cy.trigger()`, если нужно имитировать события помимо стандартных click или type, особенно для тестирования динамичных UI: всплывающие подсказки, выпадающие меню и т.п., появляющиеся при наведении.

##### cy.within()

**Пояснение:**
- **Назначение:**  
  `cy.within()` ограничивает применение последующих команд Cypress заданным элементом. Это полезно, когда нужно сузить область поиска селекторов, чтобы они работали только внутри конкретного контейнера.

- **Пример:**
  ```javascript
  // Все дальнейшие команды Cypress будут выполняться внутри формы
  cy.get('[data-testid="login-form"]').within(() => {
    cy.get('[data-testid="username-input"]').type('testUser');
    cy.get('[data-testid="password-input"]').type('password123');
  });
  ```

- **Преимущества:**  
  - Повышает надёжность тестов, предотвращая ложные срабатывания на схожих элементах на странице.
  - Упрощает селекторы за счёт ограничения области поиска.

##### Почему стоит использовать Cypress Real Events Plugin (`cypress-real-events`), а не только нативные события Cypress

**Пояснение:**
- **Ограничения нативных команд:**  
  Встроенные команды Cypress (`cy.click()`, `cy.type()`) хорошо подходят для многих взаимодействий, но иногда они не полностью имитируют поведение реального пользователя. Например, сложные движения мыши или более тонкие последовательности событий могут воспроизводиться не так, как в реальном браузере.

- **Плагин Cypress Real Events:**
  - **Назначение:**  
    Плагин `cypress-real-events` отправляет настоящие события браузера (например, реальные движения мыши или нажатия клавиш), что более точно отражает действия пользователя.
  - **Преимущества:**  
    - **Более точная имитация:** Позволяет лучше воспроизводить поведение браузера, особенно для сложных взаимодействий, выходящих за рамки простого клика.
    - **Повышение надёжности тестов:** В ряде случаев родные события Cypress не вызывают обработчики определённых сценариев, таких как сложное перетаскивание или hover.
  - **Пример:**
    ```javascript
    // Сначала установите плагин:
    // npm install cypress-real-events --save-dev

    // В поддерживающем файле Cypress (например, cypress/support/commands.js) импортируйте плагин:
    import 'cypress-real-events/support';

    // Затем используйте его в тесте:
    cy.get('[data-testid="drag-item"]').realMouseDown();
    cy.get('[data-testid="drop-zone"]').realMouseUp();
    ```

- **Когда использовать:**  
  Используйте этот плагин, когда необходимо смоделировать цепочку событий, максимально приближенную к пользовательским — например, drag-and-drop, эффекты hover с задержкой, сложные сценарии перемещения мыши.

---

## **2. Практические упражнения**

### **A. Упражнение 1: Отправка формы**
- **Цель:**
  - Создать форму логина с атрибутами `data-testid`.
  - Смоделировать ввод пользователя (логин, пароль), клик по кнопке входа, проверить сообщения об успехе/ошибке.
- **Вариант веб-функционала:**
  - Простая форма входа с валидацией.

### **B. Упражнение 2: Работа с выпадающим списком и чекбоксом**
- **Цель:**
  - Добавить выпадающий список для выбора роли пользователя и чекбокс для согласия с условиями.
  - Убедиться, что форма отправляется только при заполнении всех полей и активном чекбоксе.
- **Вариант веб-функционала:**
  - Форма, которая блокирует отправку, пока не выполнены условия валидации.

### **C. Упражнение 3: Имитация клавиатурных событий**
- **Цель:**
  - Создать строку поиска, которая фильтрует результаты в реальном времени по мере ввода.
  - Протестировать поведение поиска с помощью `.type()` и `.clear()`.
- **Вариант веб-функционала:**
  - Строка поиска с динамическим отображением совпадений.

---

## **3. Возможные вопросы студентов**

1. **Почему следует использовать атрибуты `data-*`, а не CSS-селекторы?**
   - **Ответ:** CSS-селекторы могут меняться из-за изменений в дизайне, а атрибуты `data-*` стабильны и зарезервированы для разработчиков/тестов, что делает скрипты тестирования надёжнее.

2. **Как смоделировать наведение курсора на элемент в Cypress?**
   - **Ответ:** Используйте `.trigger('mouseover')`, так как в Cypress нет отдельного метода для hover.

3. **Можно ли взаимодействовать с элементами, которые скрыты или неактивны?**
   - **Ответ:** По умолчанию Cypress запрещает взаимодействие с такими элементами, но вы можете использовать `.invoke('show')` или изменить атрибуты, чтобы смоделировать такое взаимодействие.

4. **Как проверить, что форма работает корректно?**
   - **Ответ:** Совмещайте действия (например, ввод, клик) и утверждения для подтверждения результатов, таких как появление сообщений об успехе или ошибке.

---

## **4. Дополнительные материалы**

- **Официальная документация:**
  - [Cypress Commands](https://docs.cypress.io/api/commands)
  - [Cypress Best Practices](https://docs.cypress.io/guides/references/best-practices)

- **Видео и учебные руководства:**
  - [Traversy Media: Cypress Crash Course](https://www.youtube.com/watch?v=pk4z4k8I8fU)
  - [The Net Ninja: Cypress Testing Tutorials](https://www.youtube.com/watch?v=zLtqULPDuE8)

- **Интерактивные инструменты:**
  - Практикуйтесь на таких инструментах, как [TodoMVC](http://todomvc.com).

- **Веб-сайты для практики автоматизации тестирования**
  - [Advantage eshop demo](https://advantageonlineshopping.com)
  - [DemoBlaze eshop](https://www.demoblaze.com)
  - [Tools QA](https://demoqa.com)
  - [UI Test Automation Playground](http://uitestingplayground.com)
  - [Sauce Labs](https://www.saucedemo.com)
  - [Cypress Playground](https://cypress-playground.s3.eu-central-1.amazonaws.com/index.html)
  - [Automation Exercise](https://automationexercise.com)
  - [Practice Test Automation Website for Web UI & API](https://practice.expandtesting.com)

---

### Предложенное распределение урока на 3 часа

#### **1 час: Основы выбора и взаимодействия с элементами (60 минут)**
- Введение в селекторы элементов.
- Выполнение базовых действий: клик, ввод.
- Практическая работа: заполнение и отправка формы.

#### **2 час: Продвинутые взаимодействия и работа с вводом (60 минут)**
- Работа с выпадающими списками, чекбоксами, загрузкой файлов.
- Имитация событий клавиатуры и работа с неактивными элементами.
- Практика: динамическое взаимодействие с выпадающими списками и строкой поиска.

#### **3 час: Проверка пользовательских действий (60 минут)**
- Написание утверждений для различных сценариев.
- Комбинирование действий и проверок в тест-кейсах.
- Практическая работа: тестирование и проверка поведения формы в зависимости от ввода.