## **Урок 15: Мережеві запити та базове тестування API з Cypress**

### **Мета**

- Навчитися перехоплювати та змінювати мережеві запити за допомогою Cypress.
- Зрозуміти, як підміняти відповіді (stub responses) для створення стабільного, контрольованого тестового середовища.
- Проводити базове тестування API, відправляючи запити та перевіряючи відповіді.
- Поєднувати UI- та API-тести для комплексного покриття.

---

### **Зміст уроку**

#### **Що таке API?**

**Визначення:**  
API (Application Programming Interface, Інтерфейс програмування застосунків) — це набір правил та протоколів, які дозволяють різним програмам взаємодіяти одна з одною. API визначають методи та формати даних, якими додатки можуть користуватися для запитів та обміну інформацією.

**Ключові моменти:**
- **Інтерфейс для взаємодії:**  
  Дозволяє одній програмі взаємодіяти з іншою, не знаючи її внутрішньої реалізації.
- **Типи:**  
  - **Web API:** Використовують HTTP/HTTPS для обміну інформацією між клієнтом та сервером.
  - **API бібліотек/SDK:** Надають функції для роботи з бібліотекою чи фреймворком.
- **Використання:**  
  API необхідні для інтеграції систем, отримання даних із віддалених сервісів або для підключення сторонніх інтеграцій.

#### **Що таке Backend і що таке Frontend?**

**Frontend:**
- **Визначення:**  
  Frontend — це частина додатка, з якою безпосередньо взаємодіє користувач. Включає користувацький інтерфейс (UI), HTML, CSS та JavaScript-код, що виконується в браузері.
- **Тестування:**  
  Cypress головним чином використовується для end-to-end тестування frontend, імітуючи дії користувача і перевіряючи поведінку UI.

**Backend:**
- **Визначення:**  
  Backend — це серверна частина додатка. Вона обробляє бізнес-логіку, взаємодіє з базою даних, відповідає за автентифікацію та API-ендпоінти.
- **Аспект тестування:**  
  Хоча Cypress в першу чергу використовується для тестування frontend, він також може тестувати backend API, відправляючи HTTP-запити (наприклад, через `cy.request()`) і підміняти мережеві виклики за допомогою `cy.intercept()`.

#### **Що таке HTTP Request і HTTP Response?**

**HTTP Request:**
- **Визначення:**  
  HTTP-запит — це повідомлення, яке клієнт (наприклад, браузер) надсилає серверу для отримання ресурсу чи виконання дії.
- **Компоненти:**  
  - **Метод:** GET, POST, PUT, DELETE тощо.
  - **URL:** Адреса (ендпоінт), до якого звертається клієнт.
  - **Заголовки (Headers):** Пара ключ-значення для додаткової інформації (наприклад, Content-Type, Authorization).
  - **Тіло (Body):** Дані, які надсилаються із запитом (найчастіше у POST чи PUT).

**HTTP Response:**
- **Визначення:**  
  HTTP-відповідь — це повідомлення, яке сервер надсилає клієнту після обробки запиту.
- **Компоненти:**  
  - **Код статусу:** Числовий код, що відображає результат (наприклад, 200 — успіх, 404 — не знайдено).
  - **Заголовки:** Метадані про відповідь (наприклад, Content-Type, Cache-Control).
  - **Тіло:** Основні дані або контент (HTML, JSON тощо), які повертає сервер.

#### **HTTP Headers (Заголовки)**

**Визначення:**
- **HTTP-заголовки** — це пари "ключ-значення", які надсилаються як частина HTTP-запиту або відповіді. Вони містять метадані про запит або відповідь, такі як тип контенту, кодування, політика кешування, токени аутентифікації тощо.

**Призначення і функції:**
- **Узгодження формату (Content Negotiation):**  
  Заголовки, такі як `Accept` чи `Content-Type`, вказують формат даних (наприклад, JSON, XML, HTML), який може опрацювати клієнт або формат тіла запиту.
- **Аутентифікація та безпека:**  
  Наприклад, заголовок `Authorization` (Bearer токен) використовується для аутентифікації і авторизації клієнта.
- **Кешування:**  
  Заголовки `Cache-Control`, `ETag`, `Expires` вказують, як клієнтам і проксі кешувати відповіді.
- **Інформація про клієнта та сервер:**  
  Заголовки, такі як `User-Agent` (про клієнт) і `Server` (про сервер), містять додаткові деталі про джерело та призначення запиту/відповіді.
- **Кастомні заголовки:**  
  Програми можуть використовувати власні (часто з префіксом `X-` чи `Custom-`) для передачі додаткової інформації поза стандартом.

**Приклад у запиті:**
```http
GET /api/users HTTP/1.1
Host: example.com
Accept: application/json
Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR...
User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64)
```

**Приклад у відповіді:**
```http
HTTP/1.1 200 OK
Content-Type: application/json
Cache-Control: no-cache, no-store, must-revalidate
Expires: 0
Content-Length: 123
```

**Важливість для тестування:**
- Під час тестування з Cypress ви можете змінювати заголовки (наприклад, додавати Authorization) через `cy.intercept()`.
- Перевірка заголовків є критичною для гарантії правильності та безпеки взаємодії клієнта з сервером.

#### **HTTP Body (Тіло)**

**Визначення:**
- **HTTP-тiло** — це частина HTTP-запиту або відповіді, що містить фактичні дані. У запитах це може бути форма, JSON, XML чи бінарні дані. У відповідях зазвичай повертається запитаний ресурс (HTML-сторінка, JSON-об'єкт або файл).

**Призначення та функції:**
- **Відправлення даних:**  
  У запитах POST, PUT, PATCH тіло містить дані, які клієнт бажає відправити на сервер (наприклад, форма чи файл).
- **Уявлення ресурсу:**  
  У відповідях на GET тiло містить сам ресурс — наприклад, HTML-сторінку або JSON від API.
- **Узгодження формату:**  
  Формат тiла визначається заголовком `Content-Type`, щоб клієнт та сервер правильно розуміли структуру даних.

**Приклад тiла запиту:**
- **POST-запит (JSON):**
  ```json
  {
    "username": "demoUser",
    "password": "demoPass"
  }
  ```

**Приклад тiла відповiдi:**
- **GET-запит (JSON):**
  ```json
  [
    { "id": 1, "name": "Alice" },
    { "id": 2, "name": "Bob" }
  ]
  ```

**Важливість для тестування:**
- Під час тестів API з `cy.request()` або підміни відповідей через `cy.intercept()` потрібно перевіряти відповідність тіла відповіді очікуваним даним.
- Можливо, також потрібно надсилати специфічні дані у тілі запиту, гарантуючи, що застосунок правильно обробляє payload.

#### **Що таке MOCK?**

**Визначення:**  
Mocking — це практика імітації відповідей API або інших зовнішніх сервісів шляхом заміни їх керованими, заздалегідь визначеними даними. Це використовують для:
- **Ізоляція тестів:**  
  Тести не залежать від доступності або поведінки зовнішніх систем.
- **Створення стабільних даних:**  
  Забезпечення фіксованих відповідей для передбачуваних результатів тестування.
- **Прискорення тестування:**  
  Усунення затримок у мережі та потенційної нестабільності через зовнішні сервіси.

---

#### **A. Базове тестування API**

1. **Відправка API-запитів у Cypress:**
   - **Використання `cy.request()`:**
     - **Визначення:**  
       `cy.request()` використовують для відправки HTTP-запитів безпосередньо з тесту. Ідеально підходить для тестування API-ендпоінтів без взаємодії з UI.
     - **Приклад:**
       ```javascript
       cy.request('GET', '/api/users').then((response) => {
         // Validate response here
       });
       ```

2. **Перевірка відповідей API:**
   - **Код статусу:**  
     Перевіряємо, чи статус відповіді очікуваний (наприклад, 200).
     ```javascript
     cy.request('/api/users').its('status').should('eq', 200);
     ```
   - **Тіло відповіді:**  
     Використовуйте assertions для перевірки структури і вмісту відповіді.
     ```javascript
     cy.request('/api/users').then((response) => {
       expect(response.body).to.be.an('array');
       expect(response.body[0]).to.have.property('name', 'Alice');
     });
     ```

3. **Поєднання UI і API тестів:**
   - **Варіант використання:**  
     Переконайтеся, що UI відображає ті ж дані, що і повертає API. Наприклад: отримайте дані користувачів через `cy.request()` і потім перевірте, що ті ж дані відображаються в UI.
     ```javascript
     cy.request('/api/users').then((apiResponse) => {
       cy.visit('/users');
       apiResponse.body.forEach((user, index) => {
         cy.get(`[data-testid="user-${index}"]`).should('contain', user.name);
       });
     });
     ```

---

#### **B. Перехоплення мережевих запитів**

1. **Використання `cy.intercept()`:**
   - **Визначення:**  
     `cy.intercept()` — це команда Cypress, яка дозволяє стежити за мережевими запитами (spy), перехоплювати їх та змінювати HTTP-запити і відповіді. Це критично для ізоляції тестів від бекенд-залежностей і забезпечення передбачуваних результатів.

    **Основні можливості:**
    - **Спостереження (Spying) за запитами:**  
      Перехоплення та аналіз мережевих запитів, щоб перевірити, чи вони виконуються як очікується.
    - **Підміна відповідей (Stubbing):**  
      Заміна відповідей керованими, передбачуваними даними (mock), щоб ізолювати тести від бекенду.
    - **Зміна запитів/відповідей:**  
      Можливість змінювати headers, тіло чи інші властивості перед їх обробкою додатком.

    **Чому це важливо:**
    - **Ізоляція:**  
      Декуплює тести від змін backend, забезпечуючи детермінізм тестів.
    - **Контроль:**  
      Дозволяє імітувати різні сценарії (успіх, помилки, затримки) шляхом налаштування відповідей.
    - **Гнучкість:**  
      Дозволяє тестувати обробку помилок, потоки аутентифікації й інше без зміни бекенд-сервісів.

   - **Базовий синтаксис:**
     ```javascript
     cy.intercept(method, url, response);
     ```
     - **method:** HTTP-метод (GET, POST тощо).
     - **url:** URL-ендпоінт (може бути патерн або regex).
     - **response:** Необов’язковий об’єкт для підміни відповіді.
   - **Приклад:**
     ```javascript
     // Перехоплення GET-запитів до "/api/users"
     cy.intercept('GET', '/api/users').as('getUsers');
     ```
   - **Підміна відповіді:**  
     Замість справжнього backend можна повернути свою відповідь.
     ```javascript
     cy.intercept('GET', '/api/users', {
       statusCode: 200,
       body: [{ id: 1, name: 'Alice' }, { id: 2, name: 'Bob' }],
     }).as('getUsers');
     ```

      **Приклад коду — підміна відповіді:**
      ```javascript
      cy.intercept('GET', '/api/users', {
        statusCode: 200,
        body: [{ id: 1, name: 'Alice' }, { id: 2, name: 'Bob' }],
      }).as('getUsers');

      cy.visit('/users');
      cy.wait('@getUsers').its('response.statusCode').should('eq', 200);
      ```

      **Приклад модифікації HTTP-заголовків:**
      ```javascript
      cy.intercept(
        {
          method: 'GET',
          url: '/api/secure-data'
        },
        (req) => {
          // Змінюємо заголовки перед відправленням запиту
          req.headers['Authorization'] = 'Bearer my-secret-token';
        }
      ).as('secureData');

      cy.visit('/secure');
      cy.wait('@secureData');
      ```

      ##### **6. Що таке .as() у Cypress?**

      **Визначення:**  
      `.as()` у Cypress дозволяє призначити псевдонім запиту, елементу чи іншому об’єкту. Псевдонім можна використовувати пізніше, покращуючи читабельність і багаторазове звернення.

      **Приклад використання:**
      ```javascript
      // Призначення псевдоніму перехопленому мережевому запиту
      cy.intercept('GET', '/api/users').as('getUsers');
      cy.visit('/users');
      cy.wait('@getUsers').then((interception) => {
        // Можна зробити перевірки на interception
        expect(interception.response.statusCode).to.eq(200);
      });

      // Призначення псевдоніму DOM-елементу
      cy.get('[data-testid="login-button"]').as('loginButton');
      cy.get('@loginButton').click();
      ```

      **Переваги:**
      - **Читабельність:**  
        Псевдоніми роблять кроки тесту більш описовими.
      - **Багаторазове використання:**  
        Можна звертатись до одного й того ж об’єкта/запиту у різних місцях тесту.

---

#### **C. Найкращі практики**

1. **Ізоляція тестів підміною відповідей:**
   - Stub-те мережеві відповіді через `cy.intercept()`, щоб ізолювати тести від бекенду.
   - Це зменшує нестабільність через проблеми із мережею або сервером.

2. **Детермінізм тестів:**
   - Використовуйте фіксовані, передбачувані дані для підміни відповідей.
   - Уникайте залежності від зовнішніх сервісів для стабільних результатів.

3. **Комбінування UI та API тестів:**
   - Перевіряйте, що UI відображає саме ті дані, що повертає API.
   - API-тести потрібні для перевірки бекенду, UI — для валідації представлення даних.

4. **Ясне призначення псевдонімів і логування:**
   - Використовуйте псевдоніми для перехоплених запитів (наприклад, `.as('getUsers')`) для покращення читабельності.
   - Застосовуйте логування (`cy.log()`) для зручнішого дебагу при невдачах тестів.

---

#### **D. Інші JS-фреймворки і плагіни для тестів API**

Попри чудову роботу Cypress для end-to-end та API тестування, існують також інші інструменти:
  
- **Postman/Newman:**  
  Postman — популярний інструмент для тестування API, Newman — його CLI-версія. Ідеальні для запуску тестів у CI/CD пайплайні.
  
- **Jest + Supertest:**  
  Для юніт/інтеграційного тестування API — Jest у поєднанні з Supertest надає можливість виразно тестувати бэкенд через HTTP-запити.
  
- **Mocha/Chai + Axios чи Request:**  
  Можна використовувати для API-тестів поза браузерним оточенням, зокрема для складних або бекендових сценаріїв.
  
- **Puppeteer або Playwright:**  
  Хоч ці інструменти й створені для автоматизації браузера, вони також мають хорошу підтримку перехоплення мережевих запитів та API тестів.

### **E. Практичні вправи**

1. **Перехоплення та підміна мережевих запитів:**
   - Напишіть тест, який перехоплює GET-запит до `/api/users` і підміняє відповідь кастомним результатом.
   - Переконайтесь, що додаток відображає підмінені дані.

2. **Базове API тестування:**
   - Використайте `cy.request()` для запиту до API-ендпоінту.
   - Перевірте статус, заголовки та тіло відповіді.

3. **Комбінування UI та API тестів:**
   - Створіть тест, який отримує дані через `cy.request()`, потім переходить у UI та перевіряє відображення даних, отриманих з API.

4. **Мультідомейн тестування з cy.origin:**
   - Напишіть тест, який змінює контекст на зовнішній домен (або симулюваний) і перевіряє певні елементи чи відповіді API.

5. **Менеджмент сесій через cy.session:**
   - Створіть тести, які використовують `cy.session()` для кешування стану входу, і переконайтесь, що подальші тести використовують кешовану сесію для зменшення часу налаштування.

---

### **F. Ресурси**

- **Документація Cypress щодо мережевих запитів:**  
  [Cypress Intercept Documentation](https://docs.cypress.io/api/commands/intercept)
- **Приклади API-тестів Cypress:**  
  Складіть запит на GitHub до прикладів використання `cy.request()`.
- **Мультідоменне тестування з Cypress:**  
  [cy.origin Documentation](https://docs.cypress.io/api/commands/origin)
- **Сесії в Cypress:**  
  [cy.session Documentation](https://docs.cypress.io/api/commands/session)

- **Testing API sites for practise**
  [Fake Store API](https://fakestoreapi.com/)
  [Booking app](https://restful-booker.herokuapp.com/)

---

### **Можливі запитання та відповіді**

1. **Q:** *Чому потрібно підміняти (stub) мережеві запити у тестах?*  
   **A:** Stub-ування ізолює ваші тести від змін бекенду та мережі, забезпечуючи виконання тестів з передбачуваними, стабільними даними.

2. **Q:** *Чим відрізняється cy.request() від cy.intercept()?*  
   **A:** `cy.request()` — для прямих HTTP-запитів (API-тестування). `cy.intercept()` — для спостереження або підміни мережевих запитів, що здійснюються додатком під час тесту.

5. **Q:** *Чи можна поєднувати API- та UI-тести в одному наборі?*  
   **A:** Так, поєднання забезпечує повне покриття: перевірку даних бекенду та їх правильну презентацію в UI. Наприклад, можна отримати дані через `cy.request()` і впевнитися, що UI їх правильно відображає.


   Нижче детальне пояснення HTTP Headers та HTTP Body:


  - **HTTP Headers:**  
    Надають метадані про запит чи відповідь (тип контенту, кешування, автентифікація тощо). Допомагають контролювати та визначати, як інтерпретувати дані.
    
  - **HTTP Body:**  
    Містить реальні дані, що передаються (JSON, HTML чи файловий контент). Є основою повідомлення HTTP.

  Важливість розуміння HTTP Headers і HTTP Body полягає у тому, що це дозволяє в тестах API перевіряти не лише правильність отриманих чи надісланих даних, а й коректність їхнього контексту — тип контенту, автентифікація та інша потрібна інформація.