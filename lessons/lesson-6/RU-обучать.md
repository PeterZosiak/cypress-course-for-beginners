## **Урок 6: Установка и настройка Cypress**

### **1. Структура содержания**

#### **A. Введение в установку Cypress**
- **Почему важна установка:**
  - Перед написанием тестов на Cypress необходимо правильно настроить среду, чтобы обеспечить совместимость и корректное выполнение.
- **Требования для установки:**
  - Node.js установлен в системе.
  - Базовое понимание менеджеров пакетов, таких как `npm` или `yarn`.

1. **Node.js установлен:**
   - Cypress требует Node.js для управления установкой и зависимостями.
   - Установите Node.js с официального сайта: [https://nodejs.org/](https://nodejs.org/).
   - Проверьте установку с помощью:
     ```bash
     node -v
     npm -v
     ```

2. **Менеджер пакетов:**
   - В Node.js по умолчанию входит `npm` (Node Package Manager). Также можно использовать `yarn`, `pnpm` и другие.

3. **Инициализирован JavaScript-проект:**
   - У вашего проекта должен быть файл `package.json`, который создаётся с помощью `npm init` или `yarn init`. Этот файл отслеживает зависимости, такие как Cypress, и другую метаинформацию о проекте.

4. **Базовое владение командной строкой:**
   - Для установки и запуска Cypress потребуется выполнять команды в терминале.

##### **Что такое npm и как он работает?**

**Что такое npm?**
- `npm` (Node Package Manager) — это инструмент, который поставляется с Node.js и используется для управления пакетами и зависимостями JavaScript.
- Он помогает разработчикам:
  - Устанавливать библиотеки и инструменты.
  - Делиться своими библиотеками с сообществом.
  - Управлять зависимостями как для конкретного проекта, так и глобально.

**Как работает npm:**
1. **Установка пакетов:**
   - Установить пакет локально (для конкретного проекта):
     ```bash
     npm install package-name
     ```
   - Установить пакет глобально (доступен во всех проектах):
     ```bash
     npm install -g package-name
     ```

2. **Управление зависимостями:**
   - Установленные пакеты перечислены в разделе `dependencies` или `devDependencies` файла `package.json`.

3. **Автоматизация скриптов:**
   - `npm` может запускать кастомные скрипты, определённые в `package.json`:
     ```json
     {
       "scripts": {
         "start": "node app.js",
         "test": "cypress open"
       }
     }
     ```
   - Запуск скрипта:
     ```bash
     npm run test
     ```

---

### **Отличие между npm, yarn, bun и pnpm**

| Функция               | **npm**                   | **yarn**                      | **bun**                       | **pnpm**                               |
|-----------------------|---------------------------|-------------------------------|-------------------------------|----------------------------------------|
| **Скорость**          | Средняя                   | Быстрее, чем npm              | Самая быстрая                 | Быстрее, чем npm/yarn                  |
| **Использование диска**| Выше (дублируются пакеты) | Среднее                       | Эффективное                   | Низкое (использует hard links для избежания дублирования) |
| **Дерево зависимостей**| Плоское дерево            | Плоское дерево                | Плоское дерево                | Иерархическое дерево (лучшая изоляция) |
| **Оффлайн-режим**     | Ограничен                 | Поддерживается                | Поддерживается                | Поддерживается                         |
| **Применение**        | Широко используется       | Популярен в крупных проектах  | Новый (развивающийся)         | Всё шире используется в компаниях       |
| **Лучший кейс**       | Общий случай              | Большие или производительные проекты | Быстрая разработка         | Проекты, где важна эффективная работа с зависимостями   |

#### **B. Пошаговый процесс установки**
1. **Инициализируйте проект:**
   - Создайте новую папку проекта.
   - Выполните `npm init` или `yarn init`, чтобы создать файл `package.json`.
2. **Установите Cypress:**
   - Используйте команду `npm install cypress --save-dev` или `yarn add cypress --dev`.
3. **Проверьте установку:**
   - Запустите `npx cypress open` или `yarn cypress open`, чтобы открыть Cypress Test Runner.

##### **Что такое `npm init`?**

**Назначение:**
`npm init` инициализирует новый проект Node.js, создавая файл `package.json`, который служит для управления зависимостями и скриптами проекта.

**Как это работает:**
1. Выполните `npm init` в директории проекта:
   ```bash
   npm init
   ```
2. Ответьте на вопросы (название проекта, версия, описание и др.) или пропустите их, используя флаг `-y` для значений по умолчанию:
   ```bash
   npm init -y
   ```
3. Будет создан файл `package.json`, содержащий такую информацию, как:
   ```json
   {
     "name": "my-project",
     "version": "1.0.0",
     "scripts": {},
     "dependencies": {},
     "devDependencies": {}
   }
   ```

#### **C. Обзор структуры папок Cypress**
- **Стандартные директории:**
  - `cypress/fixtures`: хранятся JSON-файлы с тестовыми данными.
  - `cypress/e2e`: здесь размещаются тестовые файлы.
  - `cypress/plugins`: расширяют функциональность Cypress.
  - `cypress/support`: содержат переиспользуемые утилиты и глобальные настройки.
- **Назначение каждой директории:**
  - **`fixtures`:** централизованное хранение мок-данных для тестов.
  - **`integration`:** организация тест-кейсов по функциональности или фиче.
  - **`support`:** кастомизация команд и глобальная настройка.

##### **Назначение папок Cypress**

1. **`fixtures`:**
   - Хранение мок-данных в формате JSON.
   - Используется для эмуляции ответов API или задания входных данных для тестов.
   - Пример: `cypress/fixtures/users.json`
     ```json
     [
       { "id": 1, "name": "Alice", "role": "admin" },
       { "id": 2, "name": "Bob", "role": "user" }
     ]
     ```
   - Получение данных в тестах:
     ```javascript
     cy.fixture('users').then((users) => {
       cy.log(users[0].name); // Выведет "Alice"
     });
     ```

2. **`e2e` (или `integration` в старых версиях):**
   - Хранятся реальные тестовые файлы, обычно организованные по функциям или особенностям.
   - Пример:
     ```
     cypress/integration/login.spec.js
     cypress/integration/dashboard.spec.js
     ```

3. **`plugins`:**
   - Расширение функционала Cypress, например, изменение поведения браузера или настройка плагинов.
   - Пример:
     ```javascript
     module.exports = (on, config) => {
       // Изменение конфигурации или установка слушателей событий
     };
     ```

4. **`support`:**
   - Содержит переиспользуемый код, такой как кастомные команды или глобальные настройки.
   - Пример: добавление команды логина в `cypress/support/commands.js`:
     ```javascript
     Cypress.Commands.add('login', (username, password) => {
       cy.get('[data-testid="username"]').type(username);
       cy.get('[data-testid="password"]').type(password);
       cy.get('[data-testid="login-button"]').click();
     });
     ```

#### **D. Конфигурационные файлы**
- **Обзор `cypress.config.js`:**
  - Настраивает базовый URL, размер экрана, тайм-ауты и прочее.
  - Пример:
    ```javascript
    const { defineConfig } = require('cypress');

    module.exports = defineConfig({
      e2e: {
        baseUrl: 'http://localhost:3000',
        viewportWidth: 1280,
        viewportHeight: 720,
        defaultCommandTimeout: 8000,
        supportFile: 'cypress/support/index.js',
      },
    });
    ```

##### **Что такое `baseUrl` в контексте Cypress?**

**Определение:**
`baseUrl` — это свойство конфигурации в `cypress.config.js`, которое задаёт корневой URL приложения для тестирования. Оно упрощает написание тестов, убирая необходимость постоянно указывать полный URL в командах `cy.visit()`.

**Пример:**
- В `cypress.config.js`:
  ```javascript
  module.exports = {
    e2e: {
      baseUrl: 'http://localhost:3000',
    },
  };
  ```
- Использование в тестах:
  ```javascript
  cy.visit('/login'); // Преобразуется в 'http://localhost:3000/login'
  ```

**Преимущества:**
- Снижает избыточность в тестовых файлах.
- Облегчает обновление тестов при смене корневого URL (например, при переходе с localhost на staging-сервер).

- **Установка переменных среды:**
  - Используйте свойство `env` в конфиге для хранения чувствительных данных или переиспользуемых переменных.
  - Пример:
    ```javascript
    module.exports = defineConfig({
      env: {
        apiUrl: 'https://api.example.com',
      },
    });
    ```
  - Доступ в тестах через `Cypress.env('apiUrl')`.

### **Свойство `env` в `cypress.config.js`**

**Определение:**
Свойство `env` в `cypress.config.js` хранит переменные среды, например, адреса API, логины или флаги. К этим значениям можно обращаться в тестах с помощью `Cypress.env()`.

**Пример:**
- В `cypress.config.js`:
  ```javascript
  module.exports = {
    e2e: {
      env: {
        apiUrl: 'https://api.example.com',
        userRole: 'admin',
      },
    },
  };
  ```
- Использование в тестах:
  ```javascript
  describe('API Tests', () => {
    it('should fetch data from the API', () => {
      const apiUrl = Cypress.env('apiUrl');
      cy.request(`${apiUrl}/users`).then((response) => {
        expect(response.status).to.eq(200);
      });
    });
  });
  ```

**Преимущества:**
- Централизует значения, зависящие от окружения, облегчая их обновление.
- Помогает не хранить чувствительные данные (например, API-ключи) прямо в коде тестов.

#### **E. Запуск тестов Cypress**
- **Открытый режим:**
  - Используйте `npx cypress open` для запуска UI Тест-Раннера.
- **Headless-режим ("безголовый"):**
  - Используйте `npx cypress run` для выполнения тестов в терминале.
  - Удобно для CI/CD пайплайнов.
- **Пример команды:**
  ```bash
  npx cypress run --spec cypress/integration/login.spec.js
  ```

**`npx`** — инструмент, входящий в состав `npm` (начиная с версии 5.2.0). Используется для прямого запуска Node.js пакетов из командной строки без глобальной установки. Позволяет запускать бинарники пакетов, установленных локально (в проекте), либо загружает их временно из реестра npm.

##### **Почему стоит использовать `npx`?**

1. **Временное выполнение:**
   - С помощью `npx` можно запускать пакет временно, не устанавливая его на постоянной основе.
   - Например:
     ```bash
     npx create-react-app my-app
     ```
     Это позволит запустить `create-react-app` без глобальной установки.

2. **Избегание глобальных установок:**
   - Вместо установки пакета глобально (`npm install -g some-package`), `npx` скачивает и запускает пакет напрямую.
   - Это помогает поддерживать чистоту глобального окружения и предотвращать конфликт версий.

3. **Запуск локальных пакетов:**
   - Если пакет уже установлен в папке проекта (`node_modules`), `npx` автоматически запускает его без необходимости указывать полный путь.
   - Пример:
     ```bash
     npx cypress open
     ```
     Это запустит Cypress из вашей локальной папки `node_modules` при наличии установки.

4. **Запуск определённой версии пакета:**
   - Можно указать нужную версию для выполнения:
     ```bash
     npx some-package@1.2.3
     ```

5. **Сценарии генераторов и scaffolding:**
   - `npx` часто используется для генерации новых проектов или конфигураций без установки инструмента глобально.
   - Пример:
     ```bash
     npx eslint --init
     ```

### **Как работает `npx`?**
- Когда вы используете команду через `npx`:
  1. Проверяется наличие пакета в вашей папке `node_modules`.
  2. Если пакет не найден локально — временно скачивается и выполняется.
  3. После выполнения временные файлы удаляются (если пакет был скачан).

---

### **Когда использовать `npx`, а когда `npm`?**

| **Функция**         | **`npm`**                             | **`npx`**                                 |
|---------------------|---------------------------------------|-------------------------------------------|
| **Установка**       | Устанавливает пакет локально/глобально| Запускает пакет без установки             |
| **Использование**   | Требует предварительной установки     | Не требует установки; выполняет сразу     |
| **Глобальные пакеты**| Для управления глобальными инструментами| Не требует глобальных установок           |
| **Разовое использование**| Не подходит без установки      | Отлично подходит для разовых запусков      |

---

### **Примеры использования `npx`**

1. **Запустить Cypress без глобальной установки:**
   ```bash
   npx cypress open
   ```

2. **Создать новое React-приложение:**
   ```bash
   npx create-react-app my-app
   ```

3. **Проверить файлы ESLint без глобальной установки:**
   ```bash
   npx eslint myfile.js
   ```

4. **Запустить определённую версию пакета:**
   ```bash
   npx some-package@2.0.0
   ```

5. **Выполнить временный запуск для теста:**
   - Например: `npx cowsay` для интереса:
     ```bash
     npx cowsay "Hello, World!"
     ```
`npx` — универсальный инструмент, упрощающий запуск пакетов и предотвращающий захламление вашей системы глобальными установками. Он особенно удобен для разработчиков, часто использующих разные JavaScript-инструменты и фреймворки.

#### **F. Лучшие практики по настройке**
- **Держите Cypress актуальным:**
  - Регулярно обновляйте Cypress для получения новых функций и исправлений багов.
- **Используйте систему контроля версий для конфигурационных файлов:**
  - Отслеживайте изменения в `cypress.config.js` и других файлах настройки.
- **Создавайте базовый URL:**
  - Укажите базовый URL в конфиге, чтобы упростить команды типа `cy.visit()`.

---

### **2. Практические занятия**

#### **A. Упражнение по установке Cypress**
- **Цель:**
  - Научить студентов устанавливать Cypress в своей среде.
- **Шаги:**
  1. Установите Node.js (если ещё не установлен).
  2. Инициализируйте новый проект командой `npm init`.
  3. Установите Cypress командой `npm install cypress --save-dev`.
  4. Запустите `npx cypress open` и изучите стандартную структуру папок.
- **Результат:**
  - Студенты должны увидеть успешно открывшийся Cypress Test Runner.

#### **B. Упражнение по настройке конфиг-файла**
- **Цель:**
  - Отредактировать файл `cypress.config.js`, чтобы добавить базовый URL и настройки viewport.
- **Шаги:**
  1. Откройте `cypress.config.js`.
  2. Добавьте следующее:
     ```javascript
     module.exports = {
       e2e: {
         baseUrl: 'http://localhost:3000',
         viewportWidth: 1366,
         viewportHeight: 768,
       },
     };
     ```
  3. Сохраните файл и перезапустите `npx cypress open`.
- **Результат:**
  - Студенты должны иметь возможность перейти к базовому URL через `cy.visit('/')` в тестах.

---

### **3. Возможные вопросы студентов**

1. **Что произойдёт, если у меня не установлен Node.js?**
   - **Ответ:** Для работы Cypress необходим установленный Node.js, потому что Cypress управляется через npm (Node Package Manager). Сначала нужно скачать и установить Node.js.

2. **Нужно ли устанавливать Cypress глобально?**
   - **Ответ:** Нет, Cypress обычно устанавливается локально в проекте для лучшего управления версиями и воспроизводимости.

3. **В чём разница между режимом open и headless у Cypress?**
   - **Ответ:** В режиме open запускается интерактивный Test Runner с визуализацией процесса тестирования. В headless-режиме тесты запускаются в терминале без UI, что удобно для автоматизации.

4. **Зачем использовать базовый URL в конфиге?**
   - **Ответ:** Это упрощает команды тестирования. Вместо `cy.visit('http://localhost:3000/login')` можно писать `cy.visit('/login')`.

5. **Можно ли использовать Cypress в существующих проектах?**
   - **Ответ:** Да, Cypress можно добавить в любой JavaScript-проект, установив как зависимость для разработки.

---

### **4. Дополнительные материалы**

#### **A. Официальная документация:**
- [Cypress Installation Guide](https://docs.cypress.io/guides/getting-started/installing-cypress)
- [Cypress Configuration](https://docs.cypress.io/guides/references/configuration)

#### **B. Туториалы и статьи:**
- [Cypress Folder Structure and Setup](https://docs.cypress.io/guides/core-concepts/writing-and-organizing-tests)
- [Beginner's Guide to Installing Cypress](https://blog.testproject.io/2021/01/05/getting-started-with-cypress/)

#### **C. Видео:**
- **Traversy Media:** Cypress Crash Course
- **The Net Ninja:** Getting Started with Cypress Testing

#### **D. Платформы для практики:**
- Настройте Cypress на простом приложении TodoMVC или онлайн-демо вроде `http://todomvc.com`.

---

### **5. Примерный план урока на 3 часа**

#### **Час 1: Введение и установка (60 минут)**
- **Установка Cypress (30 минут):**
  - Пошагово провести студентов через процесс установки.
  - Проверить работу через `npx cypress open`.
- **Обзор структуры папок (20 минут):**
  - Объяснить назначение каждой папки.
  - Рассказать, где писать тесты и хранить мок-данные.
- **Вопросы и ответы (10 минут):**
  - Ответить на вопросы по установке.

#### **Час 2: Настройка Cypress (60 минут)**
- **Создание и редактирование `cypress.config.js` (30 минут):**
  - Настроить базовый URL, размер viewport и переменные среды.
  - Пояснить важность конфигурационных файлов.
- **Практика (20 минут):**
  - Отредактировать конфиг и подтвердить изменения, перезапустив Test Runner.
- **Вопросы (10 минут):**
  - Разобрать непонятные моменты по настройке.

#### **Час 3: Запуск тестов Cypress (60 минут)**
- **Режимы open и headless (20 минут):**
  - Показать оба режима и объяснить, где какой использовать.
- **Изучение примеров тестов (30 минут):**
  - Запустить примерные тесты в Cypress и разобрать встроенные возможности.
  - Обсудить структуру пользовательских тестов в папке `integration`.
- **Резюме и вопросы (10 минут):**
  - Повторить основные этапы установки и настройки.
  - Ответить на завершающие вопросы и подготовить студентов к следующему занятию.

---

### **6. Дополнительные рекомендации**

#### **Интерактивные демонстрации:**
- Покажите студентам, как решать типичные проблемы с установкой (например, права доступа, отсутствие Node.js).
- Демонстрируйте изменения в `cypress.config.js` и их влияние в режиме live.

#### **Стимулируйте участие:**
- Пусть студенты самостоятельно попробуют установить Cypress и помогут друг другу.
- Предлагайте поэкспериментировать с разными настройками, как, например, тайм-ауты или размер viewport.

#### **Давайте чёткие инструкции:**
- Пошаговые команды установки и настройки.
- Рекомендации по организации папки `integration` для масштабируемых тестов.

#### **Делайте упор на практику:**
- Используйте примеры из жизни, например, настройка базового URL для тестового приложения.
- Объясните, как качественная настройка влияет на поддерживаемость и масштабируемость автоматизации тестирования.