## **Урок 16: Введение в плагины и расширения Cypress (кратко)**

### **Цели**

- Изучить роль плагинов и расширений Cypress в расширении возможностей тестирования.
- Научиться устанавливать, настраивать и использовать популярные Cypress-плагины.
- Понять лучшие практики выбора и поддержки конфигураций плагинов для обеспечения эффективности и управляемости вашего набора тестов.

---

### **Структура содержания**

#### **A. Плагины Cypress**

1. **Что такое плагины Cypress?**
   - **Определение:**  
     Плагины Cypress — это модули или библиотеки, которые расширяют основную функциональность Cypress. Они позволяют настраивать и улучшать процесс выполнения тестов.
   - **Назначение:**  
     - Расширяют возможности Cypress, выходящие за пределы встроенных функций.
     - Интегрируются с внешними инструментами и фреймворками.
     - Автоматизируют задачи, такие как отчёты, тестирование доступности, обработка загрузок файлов.

    #### **Модули и библиотеки в разработке на Node.js**

    ##### **Модули:**

    - **Определение:**  
      В Node.js модуль — это отдельный фрагмент кода — часто отдельный файл или набор файлов — который может экспортировать функциональность (например, функции, объекты или классы) и импортировать ее из других модулей. Модули помогают организовать код в повторно используемые и поддерживаемые части.

    - **Как работают модули:**  
      Node.js по умолчанию использует систему модулей CommonJS (с помощью `require()` и `module.exports`), однако теперь также поддерживает ES-модули (с помощью `import` и `export`). Каждый модуль имеет свою собственную область видимости, то есть переменные и функции одного модуля недоступны в другом без явного экспорта.

    - **Типы модулей:**
      - **Встроенные модули:**  
        Node.js содержит множество встроенных модулей (например, `fs` для работы с файловой системой, `http` для создания серверов, `path` для работы с путями файлов).  
        *Пример:*  
        ```javascript
        const fs = require('fs');
        ```
      - **Сторонние модули:**  
        Модули, опубликованные в npm (Node Package Manager), которые вы можете установить и использовать в своих проектах (например, `express`, `lodash`, `axios`).  
        *Пример:*  
        ```javascript
        const express = require('express');
        ```
      - **Пользовательские модули:**  
        Модули, которые вы пишете самостоятельно для реализации специфической бизнес-логики.  
        *Пример:*  
        ```javascript
        // math.js
        function add(a, b) { return a + b; }
        module.exports = { add };
        ```

    ##### **Библиотеки:**

    - **Определение:**  
      Библиотека — это коллекция модулей, предназначенных для предоставления набора функций. Библиотеки ускоряют разработку за счет повторного использования общей логики (например, фреймворки типа Express для создания web-приложений).

    - **Отличие между модулями и библиотеками:**  
      - **Модуль:** Обычно единичный компонент кода с конкретной задачей.  
      - **Библиотека:** Набор модулей, предоставляющих более широкий функционал.

    - **Примеры в Node.js:**  
      - **Express:** Библиотека для создания web-серверов и API.  
      - **Lodash:** Утилита-библиотека для обработки данных.

    ##### **Почему эти плагины полезны:**

    - **Расширяют возможности тестирования:**  
      Позволяют выполнять задачи, которые иначе потребовали бы написания кастомного кода.
      
    - **Улучшают опыт разработчика:**  
      Благодаря дополнительным командам и более информативной отчётности становится легче отлаживать и поддерживать тесты.
      
    - **Повышают надёжность тестов:**  
      Подменяя сетевые запросы, эмулируя действия пользователя или управляя сессиями, плагины позволяют сократить нестабильность тестов (flakiness).
      
    - **Поддержка специфических задач:**  
      Необходимы тесты на доступность, визуальную регрессию, продвинутую аутентификацию — скорее всего, для вашей задачи уже есть подходящий плагин.


2. **Установка и настройка необходимых Cypress-плагинов:**
   - **Процесс установки:**
     - Обычно плагины устанавливаются через npm (например, `npm install cypress-axe --save-dev`).
   - **Конфигурация:**
     - После установки плагины часто настраиваются в файле `cypress.config.js` или в файлах внутри директории `cypress/plugins/`.
   - **Пример — установка cypress-axe для тестирования доступности:**
     ```bash
     npm install cypress-axe --save-dev
     ```
     - Затем в вашем `cypress/support/commands.js` или `cypress/support/index.js` импортируйте и инициализируйте плагин:
     ```javascript
     import 'cypress-axe';
     ```
     - Теперь в тестах можно использовать команды `cy.injectAxe()` и `cy.checkA11y()`.

3. **Обзор популярных плагинов:**
    В экосистеме Cypress есть множество плагинов, расширяющих его функциональность. Ниже представлены 15–20 важных или популярных плагинов с кратким описанием каждого:

    1. **cypress-axe:**  
      - Интегрирует движок тестирования доступности axe с Cypress для автоматизации проверки доступности.
      
    2. **cypress-grep:**  
      - Позволяет фильтровать и запускать тесты по тегам или паттернам, облегчая выполнение частей тестового набора.
      
    3. **cypress-file-upload:**  
      - Предоставляет команды для симуляции загрузки файлов в тестах.
      
    4. **cypress-real-events:**  
      - Эмулирует нативные браузерные события (например, реальные движения мыши или события клавиатуры) для более реалистичного тестирования.
      
    5. **cypress-mochawesome-reporter:**  
      - Генерирует красивые интерактивные отчёты о тестах с помощью Mochawesome reporter.
      
    6. **cypress-cucumber-preprocessor:**  
      - Позволяет писать тесты на синтаксисе Gherkin (Cucumber), полезен для BDD-подхода.
      
    7. **cypress-wait-until:**  
      - Добавляет команду для ожидания выполнения условия, полезно для работы с асинхронным поведением.
      
    8. **cypress-failed-log:**  
      - Логирует дополнительные детали (например, сетевые запросы) при падении теста, что помогает в отладке.
      
    9. **cypress-shadow-dom:**  
      - Улучшает поддержку тестирования компонентов с Shadow DOM, предоставляя команды для работы с ним.
      
    10. **cypress-select-tests:**  
        - Помогает выбирать и запускать конкретные тесты по тегам или соглашениям в имени.
      
    11. **cypress-plugin-tab:**  
        - Эмулирует события клавиши Tab для улучшения тестирования навигации по клавиатуре.
      
    12. **cypress-ntlm-auth:**  
        - Добавляет поддержку NTLM-аутентификации, полезно для корпоративных сред.
      
    13. **cypress-mock-server:**  
        - Позволяет симулировать работу бэкенд-сервера через локальный mock-сервер.
      
    14. **cypress-log-to-output:**  
        - Перенаправляет логи Cypress в терминал или файл, полезно для CI.
      
    15. **cypress-testrail:**  
        - Интегрирует Cypress с TestRail — инструментом управления тест-кейсами — для автоматизации обновления тестов.
      
    16. **cypress-react-selector:**  
        - Позволяет выбирать React-компоненты по имени, делая тесты для приложений на React более понятными.
      
    17. **cypress-drag-drop:**  
        - Добавляет команды для симуляции drag-and-drop действий в браузере.
      
    18. **cypress-iframe:**  
        - Упрощает тестирование iframes, предоставляя команды для работы с содержимым внутри iframe.
      
    19. **cypress-stub:**  
        - Предоставляет утилиты для подмены (стаба) и слежения за функциями, полезно для юнит-тестирования и изоляции поведения.
      
    20. **cypress-visual-regression:**  
        - Интегрирует возможности визуального регрессионного тестирования, позволяя обнаруживать визуальные изменения в приложении.

---

#### **B. Расширения**

1. **Расширение функциональности Cypress с помощью расширений:**
   - **Определение:**  
     Расширениями могут быть как обычные плагины, так и дополнительные JavaScript‑модули, расширяющие функциональные возможности Cypress.
   - **Пользовательские плагины:**  
     Можно написать собственные плагины для реализации специфических требований (например, кастомное логирование, интеграция с CI-системой).
   - **Примеры:**  
     - Создание кастомной задачи для чтения из файла или записи в файл.
     - Расширение Cypress-команд для создания абстракций повторяющихся UI-действий.

---

#### **C. Лучшие практики**

1. **Выбор подходящих плагинов:**
   - **Избегайте избытка плагинов:**  
     Используйте только те плагины, которые действительно приносят пользу вашему тестовому набору. Лишние плагины замедляют выполнение тестов и усложняют поддержку.
   - **Оценка поддержки и активности в сообществе:**  
     Выбирайте активно поддерживаемые плагины с сильным сообществом — это обеспечит совместимость с новыми версиями Cypress.

2. **Поддержка конфигураций плагинов:**
   - **Централизуйте конфигурацию:**  
     Храните конфигурации плагинов в `cypress.config.js` или выделенных конфигах для обеспечения консистентности.
   - **Документируйте изменения:**  
     Отслеживайте версии плагинов и изменения конфигурации в документации или комментариях системы контроля версий.
   - **Проводите периодические ревью:**  
     Регулярно пересматривайте список плагинов, чтобы удалять неактуальные или обновлять устаревшие.

---

#### **D. Практические задания**

1. **Установите и настройте плагин Cypress Axe:**
   - **Задание:**  
     Установите плагин `cypress-axe` в демонстрационный проект.
   - **Шаги:**
     - Установите через npm.
     - Импортируйте плагин в support-файл.
     - Напишите простой тест, который внедряет axe и проверяет наличие ошибок доступности.
   - **Пример кода:**
     ```javascript
     // cypress/support/commands.js или index.js
     import 'cypress-axe';

     // В тестовом файле:
     describe('Accessibility Testing with cypress-axe', () => {
       beforeEach(() => {
         cy.visit('/');
         cy.injectAxe();
       });

       it('should have no detectable accessibility violations on the Home page', () => {
         cy.checkA11y();
       });
     });
     ```


2. **Установите и настройте плагин Cypress Cucumber:**
    ##### **1. Feature-файл (login.feature)**

    Создайте файл (например, `cypress/e2e/login.feature`) со следующим содержанием:

    ```gherkin
    Feature: User Login

      As a registered user
      I want to log in to the application
      So that I can access my dashboard

      Scenario: Successful login with valid credentials
        Given I open the login page
        When I enter valid credentials
        And I submit the login form
        Then I should see a welcome message
    ```

    **Пояснение:**
    - **Feature** раскрывает общую суть пользовательской истории.
    - **Scenario** описывает конкретный кейс: успешный вход пользователя.
    - **Steps** (Given, When, And, Then) выражают поведение на естественном языке.

    ---

    ##### **2. Step-определения (login.steps.js)**

    Создайте файл определений шагов (например, `cypress/e2e/login.steps.js`) со следующим содержанием:

    ```javascript
    import { Given, When, Then } from '@badeball/cypress-cucumber-preprocessor';

    Given('I open the login page', () => {
      cy.visit('/login'); // Предполагается, что baseUrl задан в cypress.config.js
    });

    When('I enter valid credentials', () => {
      // Замените на свои селекторы и валидные данные пользователя
      cy.get('[data-testid="login-username-input"]').type('demoUser');
      cy.get('[data-testid="login-password-input"]').type('demoPass');
    });

    When('I submit the login form', () => {
      cy.get('[data-testid="login-submit-button"]').click();
    });

    Then('I should see a welcome message', () => {
      cy.get('[data-testid="login-success-message"]')
        .should('be.visible')
        .and('contain', 'Welcome'); // Подкорректируйте в зависимости от текстов приложения
    });
    ```

    **Пояснение:**
    - Определения шагов реализуются с помощью функций `Given`, `When`, `Then` из препроцессора.
    - Каждый шаг связывается с текстом из feature-файла.
    - Команды внутри шага эмулируют пользовательские действия и проверки с помощью Cypress.

    ##### **3. Настройка cypress-cucumber-preprocessor**

    1. **Установка:**  
      Установите нужные пакеты:
      ```bash
      npm install --save-dev @badeball/cypress-cucumber-preprocessor
      npm install --save-dev @bahmutov/cypress-esbuild-preprocessor
      ```
      
    2. **Конфигурация:**  
      Измените `cypress.config.js` для интеграции препроцессора:
      ```javascript
      import { defineConfig } from 'cypress';
      import createBundler from "@bahmutov/cypress-esbuild-preprocessor"
      import { addCucumberPreprocessorPlugin } from "@badeball/cypress-cucumber-preprocessor"
      import createEsbuildPlugin from "@badeball/cypress-cucumber-preprocessor/esbuild"

      export default defineConfig({
        e2e: {
          specPattern: '**/*.feature', // Feature-файлы будут найдены
          async setupNodeEvents(on, config) {
            // Инициализация препроцессора
            await addCucumberPreprocessorPlugin(on, config)
            on(
              "file:preprocessor",
              createBundler({
                plugins: [createEsbuildPlugin(config)],
              })
            )
            return config;
          },
        },
      });
      ```
      
    3. **Запуск тестов:**  
      Запустите ваши тесты стандартным способом:
      ```bash
      npx cypress open
      ```
      В тест-раннере отобразятся ваши feature-файлы, вы сможете запускать их, как обычные e2e‑тесты.

    ##### **Кратко**

    - **BDD с Cypress:**  
      Пример выше показывает как писать BDD-тесты с помощью синтаксиса Gherkin в feature‑файле и реализовывать шаги на JavaScript.
    - **Преимущества:**  
      - Улучшает читаемость тестов.
      - Сближает понимание бизнеса и разработчиков.
      - Помогает связывать тесты с бизнес-требованиями.

---

#### **E. Ресурсы**

- **Документация по плагинам Cypress:**  
  [Cypress Plugins](https://docs.cypress.io/guides/references/plugin-api)
- **Документация cypress-axe:**  
  [cypress-axe GitHub Repository](https://github.com/component-driven/cypress-axe)
- **Плагин cypress-grep:**  
  [cypress-grep GitHub Repository](https://github.com/cypress-io/cypress-grep)
- **Примеры сообщества:**  
  Ищите open-source проекты на Cypress, демонстрирующие работу плагинов и расширений.

---

### **Возможные вопросы и ответы студентов**

1. **В:** *Что такое плагины Cypress и почему они важны?*  
   **О:** Плагины Cypress — это модули, расширяющие функциональность Cypress. Они позволяют добавить функции, такие как тесты доступности, загрузка файлов и многое другое, что делает ваш набор тестов более гибким и полным.

2. **В:** *Как cypress-axe улучшает наш процесс тестирования?*  
   **О:** cypress-axe интегрирует движок доступности axe с Cypress, предоставляя автоматизированное тестирование доступности. Это помогает обеспечить соответствие вашего приложения стандартам доступности без ручной проверки.

3. **В:** *В чем разница между плагином и расширением в Cypress?*  
   **О:** Оба расширяют функциональность Cypress, но плагины обычно устанавливаются через npm и настраиваются в конфиге Cypress. Расширения могут включать кастомный код или модули, написанные вами для специфических задач тестирования.

4. **В:** *Почему не следует использовать слишком много плагинов?*  
   **О:** Каждый плагин увеличивает нагрузку на набор тестов. Избыток плагинов замедляет выполнение тестов и усложняет сопровождение. Важно выбирать только те плагины, которые приносят явную пользу и поддерживаются сообществом.

5. **В:** *Что делать, если конфигурация плагина ломает мои тесты?*  
   **О:** Изучите документацию к плагину, проверьте конфликты с текущими настройками, попытайтесь воспроизвести конфликт на простом тесте для локализации проблемы. Также стоит централизованно хранить и документировать все конфигурации плагинов.