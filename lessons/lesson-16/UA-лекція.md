## **Урок 16: Вступ до плагінів та розширень Cypress (Скорочено)**

### **Цілі**

- Дослідити роль плагінів і розширень Cypress у розширенні можливостей тестування.
- Дізнатися, як встановлювати, налаштовувати й використовувати популярні плагіни Cypress.
- Зрозуміти найкращі практики у виборі та підтримці налаштувань плагінів, щоб ваш набір тестів був ефективним і керованим.

---

### **Структура змісту**

#### **A. Плагіни Cypress**

1. **Що таке плагіни Cypress?**
   - **Визначення:**  
     Плагіни Cypress — це модулі або бібліотеки, які розширюють основну функціональність Cypress. Вони дозволяють налаштовувати та покращувати виконання тестів.
   - **Призначення:**  
     - Розширення можливостей Cypress понад вбудовані функції.
     - Інтеграція із зовнішніми інструментами та фреймворками.
     - Автоматизація таких задач, як звітування, тестування доступності та обробка завантажень файлів.

    #### **Модулі та бібліотеки в розробці Node.js**

    ##### **Модулі:**

    - **Визначення:**  
      У Node.js модуль — це автономний фрагмент коду, часто окремий файл або набір файлів, який може експортувати функціональність (таку як функції, об'єкти або класи) та імпортувати функціональність з інших модулів. Модулі допомагають організовувати код у повторно використовувані, підтримувані частини.

    - **Як працюють модулі:**  
      Node.js за замовчуванням використовує систему модулів CommonJS (за допомогою `require()` і `module.exports`), хоча тепер також підтримує ES Modules (за допомогою `import` і `export`). Кожен модуль має власну область видимості — це означає, що змінні й функції, визначені в одному модулі, недоступні в іншому, якщо їх не експортувати явно.

    - **Типи модулів:**
      - **Вбудовані модулі:**  
        Node.js має багато вбудованих модулів (наприклад, `fs` для роботи з файловою системою, `http` для створення серверів, `path` для обробки шляхів файлів).  
        *Приклад:*  
        ```javascript
        const fs = require('fs');
        ```
      - **Сторонні модулі:**  
        Модулі, опубліковані на npm (Node Package Manager), які можна встановити і використовувати у своїх проєктах (наприклад, `express`, `lodash`, `axios`).  
        *Приклад:*  
        ```javascript
        const express = require('express');
        ```
      - **Користувацькі модулі:**  
        Модулі, які ви пишете самостійно для інкапсуляції специфічної функціональності додатка.  
        *Приклад:*  
        ```javascript
        // math.js
        function add(a, b) { return a + b; }
        module.exports = { add };
        ```

    ##### **Бібліотеки:**

    - **Визначення:**  
      Бібліотека — це колекція модулів, призначена для надання набору функціональностей. Бібліотеки можна використовувати для прискорення розробки шляхом повторного використання загальної логіки (наприклад, фреймворки як Express для створення веб-додатків).

    - **Різниця між модулями та бібліотеками:**  
      - **Модуль:** Зазвичай — це один блок коду з конкретною відповідальністю.  
      - **Бібліотека:** Колекція модулів, які надають ширший спектр функцій.

    - **Приклади у Node.js:**  
      - **Express:** Бібліотека для створення веб-серверів і API.  
      - **Lodash:** Утилітарна бібліотека, що надає багато допоміжних функцій для роботи з даними.

    ##### **Чому ці плагіни корисні:**

    - **Розширення можливостей тестування:**  
      Вони розширюють основну функціональність Cypress, дозволяючи виконувати завдання, які зазвичай вимагали б написання власного коду.
      
    - **Покращення досвіду розробника:**  
      Додаткові команди та кращі звіти роблять налагодження й підтримку тестів простішими.
      
    - **Забезпечення надійності тестів:**  
      Плагіни можуть підміняти мережеві запити, імітувати дії користувача або керувати сесіями тестів, що допомагає зменшити нестабільність тестів.
      
    - **Підтримка специфічних потреб тестування:**  
      Якщо потрібно провести тестування доступності, перевірку візуальної регресії або складну аутентифікацію, майже завжди знайдеться плагін для цієї задачі.


2. **Встановлення та налаштування основних плагінів Cypress:**
   - **Процес встановлення:**
     - Зазвичай плагіни встановлюються через npm (наприклад, `npm install cypress-axe --save-dev`).
   - **Налаштування:**
     - Після встановлення плагіни часто конфігуруються у файлі `cypress.config.js` або у файлах у каталозі `cypress/plugins/`.
   - **Приклад – встановлення cypress-axe для тестування доступності:**
     ```bash
     npm install cypress-axe --save-dev
     ```
     - Далі у вашому `cypress/support/commands.js` або `cypress/support/index.js` імпортуйте і ініціалізуйте плагін:
     ```javascript
     import 'cypress-axe';
     ```
     - Тепер у тестах можна використовувати такі команди, як `cy.injectAxe()` та `cy.checkA11y()`.

3. **Огляд популярних плагінів:**
    В екосистемі Cypress є багато плагінів, що розширюють його функціонал. Ось 15–20 важливих чи популярних плагінів з коротким описом кожного:

    1. **cypress-axe:**  
      - Інтегрує рушій доступності axe з Cypress для автоматизації перевірок доступності.
      
    2. **cypress-grep:**  
      - Дозволяє фільтрувати й запускати тести на основі тегів або патернів, спрощуючи виконання підмножин тестового набору.
      
    3. **cypress-file-upload:**  
      - Додає команди для імітації завантаження файлів у тестах.
      
    4. **cypress-real-events:**  
      - Імітує нативні браузерні події (наприклад, реальні рухи миші чи клавіатурні події) для більш реалістичного тестування.
      
    5. **cypress-mochawesome-reporter:**  
      - Генерує гарні, інтерактивні звіти тестування за допомогою Mochawesome reporter.
      
    6. **cypress-cucumber-preprocessor:**  
      - Дозволяє писати тести у синтаксисі Gherkin з Cucumber, корисно для поведінкового тестування (BDD).
      
    7. **cypress-wait-until:**  
      - Додає кастомну команду для очікування виконання умови, корисно для асинхронної поведінки.
      
    8. **cypress-failed-log:**  
      - Додає деталізоване логування (наприклад, мережевих запитів), коли тест не проходить, що допомагає при налагодженні.
      
    9. **cypress-shadow-dom:**  
      - Покращує підтримку тестування компонентів з Shadow DOM шляхом надання кастомних команд для його обходу.
      
    10. **cypress-select-tests:**  
        - Допомагає вибирати й виконувати конкретні тести за тегами чи назвами.
      
    11. **cypress-plugin-tab:**  
        - Імітує натискання клавіші Tab для перевірки навігації клавіатурою.
      
    12. **cypress-ntlm-auth:**  
        - Додає підтримку NTLM-аутентифікації, корисно для корпоративних середовищ.
      
    13. **cypress-mock-server:**  
        - Дозволяє імітувати поведінку бекенда, створюючи локальний сервер-замінник.
      
    14. **cypress-log-to-output:**  
        - Перенаправляє лог Cypress у термінал або файл-виводу, що зручно для CI-середовищ.
      
    15. **cypress-testrail:**  
        - Інтегрує Cypress з TestRail для автоматизації оновлення тест-кейсів.
      
    16. **cypress-react-selector:**  
        - Дозволяє вибирати React-компоненти за їхніми іменами — робить тести для React-застосунків більш інтуїтивними.
      
    17. **cypress-drag-drop:**  
        - Додає команди для імітації дій drag-and-drop у браузері.
      
    18. **cypress-iframe:**  
        - Робить тестування iframe простішим, надаючи команди для взаємодії з вмістом iframe.
      
    19. **cypress-stub:**  
        - Додає утиліти для підміни та стеження за функціями — зручно для юніт-тестування та ізоляції поведінки.
      
    20. **cypress-visual-regression:**  
        - Інтегрує тестування візуальної регресії, дозволяючи виявляти візуальні зміни у вашому застосунку.

---

#### **B. Розширення**

1. **Розширення функціоналу Cypress за допомогою розширень:**
   - **Визначення:**  
     Розширенням можуть бути як плагіни, так і додаткові JavaScript-модулі, які ще більше розширюють можливості Cypress.
   - **Користувацькі плагіни:**  
     Ви можете написати власні плагіни для вирішення специфічних завдань тестування (наприклад, кастомне логування, інтеграція з CI).
   - **Приклади:**  
     - Створення кастомного завдання для читання чи запису у файл.
     - Розширення команд Cypress для створення високорівневих абстракцій для повторюваних UI-взаємодій.

---

#### **C. Найкращі практики**

1. **Вибір відповідних плагінів:**
   - **Уникайте надмірного навантаження:**  
     Використовуйте лише ті плагіни, які додають очевидну цінність для вашого набору тестів. Зайві плагіни можуть уповільнити виконання тестів і ускладнити обслуговування.
   - **Оцінюйте підтримку та спільноту:**  
     Використовуйте плагіни, які активно підтримуються й мають сильну спільноту, щоб забезпечити сумісність із новими версіями Cypress.

2. **Підтримання конфігурацій плагінів:**
   - **Централізуйте налаштування:**  
     Зберігайте налаштування плагінів у `cypress.config.js` або окремих файлах конфігурації для забезпечення послідовності.
   - **Документуйте зміни:**  
     Відстежуйте версії плагінів і зміни в конфігураціях у документації або коментарях у контролі версій.
   - **Періодичний огляд:**  
     Регулярно переглядайте список плагінів і видаляйте непотрібні або оновлюйте застарілі.

---

#### **D. Діяльність**

1. **Встановлення та налаштування плагіна Cypress Axe:**
   - **Завдання:**  
     Встановіть плагін, як-от `cypress-axe`, у вашому тестовому проєкті.
   - **Кроки:**
     - Встановіть через npm.
     - Імпортуйте плагін у файл додаткових команд.
     - Напишіть простий тест, що підключає axe та перевіряє на порушення доступності.
   - **Приклад коду:**
     ```javascript
     // cypress/support/commands.js або index.js
     import 'cypress-axe';

     // У тест-файлі:
     describe('Accessibility Testing with cypress-axe', () => {
       beforeEach(() => {
         cy.visit('/');
         cy.injectAxe();
       });

       it('should have no detectable accessibility violations on the Home page', () => {
         cy.checkA11y();
       });
     });
     ```

2. **Встановлення та налаштування плагіна Cypress Cucumber:**
    ##### **1. Файл фічі (login.feature)**

    Створіть файл (наприклад, `cypress/e2e/login.feature`) із таким вмістом:

    ```gherkin
    Feature: User Login

      As a registered user
      I want to log in to the application
      So that I can access my dashboard

      Scenario: Successful login with valid credentials
        Given I open the login page
        When I enter valid credentials
        And I submit the login form
        Then I should see a welcome message
    ```

    **Пояснення:**
    - **Feature**-розділ дає загальний огляд користувацької історії.
    - **Scenario** описує конкретний випадок: успішний вхід.
    - **Steps** (Given, When, And, Then) описують поведінку звичайною мовою.

    ---

    ##### **2. Step Definitions (login.steps.js)**

    Створіть файл зі визначеннями кроків (наприклад, `cypress/e2e/login.steps.js`) з наступним вмістом:

    ```javascript
    import { Given, When, Then } from '@badeball/cypress-cucumber-preprocessor';

    Given('I open the login page', () => {
      cy.visit('/login'); // Передбачається, що baseUrl налаштований у cypress.config.js
    });

    When('I enter valid credentials', () => {
      // Замініть на ваші селектори та дійсні облікові дані
      cy.get('[data-testid="login-username-input"]').type('demoUser');
      cy.get('[data-testid="login-password-input"]').type('demoPass');
    });

    When('I submit the login form', () => {
      cy.get('[data-testid="login-submit-button"]').click();
    });

    Then('I should see a welcome message', () => {
      cy.get('[data-testid="login-success-message"]')
        .should('be.visible')
        .and('contain', 'Welcome'); // Змініть відповідно до фактичного повідомлення у вашому застосунку
    });
    ```

    **Пояснення:**
    - Визначення кроків використовують функції `Given`, `When` і `Then`, імпортовані з препроцесора.
    - Кожен крок відповідає фразі з файлу фічі.
    - Команди всередині кроків імітують дії користувача й асертизацію в Cypress.

    ##### **3. Налаштування cypress-cucumber-preprocessor**

    1. **Встановлення:**  
      Встановіть необхідні пакети:
      ```bash
      npm install --save-dev @badeball/cypress-cucumber-preprocessor
      npm install --save-dev @bahmutov/cypress-esbuild-preprocessor
      ```
      
    2. **Налаштування:**  
      Оновіть ваш `cypress.config.js` для інтеграції препроцесора:
      ```javascript
      import { defineConfig } from 'cypress';
      import createBundler from "@bahmutov/cypress-esbuild-preprocessor"
      import { addCucumberPreprocessorPlugin } from "@badeball/cypress-cucumber-preprocessor"
      import createEsbuildPlugin from "@badeball/cypress-cucumber-preprocessor/esbuild"

      export default defineConfig({
        e2e: {
          specPattern: '**/*.feature', // Щоб були помічені ваші файли features
          async setupNodeEvents(on, config) {
            // ініціалізуйте препроцесор
            await addCucumberPreprocessorPlugin(on, config)
            on(
              "file:preprocessor",
              createBundler({
                plugins: [createEsbuildPlugin(config)],
              })
            )
            return config;
          },
        },
      });
      ```
      
    3. **Запуск тестів:**  
      Запустіть тести як зазвичай:
      ```bash
      npx cypress open
      ```
      Це покаже ваші файли features у Cypress Test Runner, і ви зможете запускати їх як звичайні end-to-end тести.

    ##### **Підсумок**

    - **BDD з Cypress:**  
      Наведений вище приклад демонструє, як написати BDD-тест у стилі Gherkin у файлі feature, а потім імплементувати кроки на JavaScript.
    - **Переваги:**  
      - Покращує читабельність тестів.
      - Долучає нетехнічних фахівців до процесу.
      - Допомагає забезпечити відповідність тестів бізнес-вимогам.

---

#### **E. Ресурси**

- **Документація плагінів Cypress:**  
  [Cypress Plugins](https://docs.cypress.io/guides/references/plugin-api)
- **Документація cypress-axe:**  
  [cypress-axe GitHub Repository](https://github.com/component-driven/cypress-axe)
- **Плагін cypress-grep:**  
  [cypress-grep GitHub Repository](https://github.com/cypress-io/cypress-grep)
- **Приклади спільноти:**  
  Шукайте open-source проєкти на Cypress, які демонструють плагіни та розширення у дії.

---

### **Поширені питання студентів і відповіді**

1. **Q:** *Що таке плагіни Cypress і чому вони важливі?*  
   **A:** Плагіни Cypress — це модулі, які розширюють можливості Cypress. Вони дозволяють додавати такі функції, як тестування доступності, завантаження файлів тощо, що робить ваш набір тестів більш потужним і комплексним.

2. **Q:** *Як cypress-axe покращує наш процес тестування?*  
   **A:** cypress-axe інтегрує рушій доступності axe із Cypress, забезпечуючи автоматизоване тестування доступності. Це допомагає гарантувати, що ваш додаток відповідає стандартам доступності без ручного втручання.

3. **Q:** *Яка різниця між плагіном і розширенням у Cypress?*  
   **A:** Хоча і плагіни, і розширення розширюють функціонал Cypress, плагіни зазвичай встановлюються з npm і налаштовуються через конфігураційний файл Cypress. Розширення можуть містити користувацький код чи модулі, які ви самі пишете для вирішення конкретних потреб тестування.

4. **Q:** *Чому слід уникати надмірного використання плагінів?*  
   **A:** Кожний плагін додає додатковий код та навантаження до вашого набору тестів. Надмірне використання плагінів може сповільнити тестування й підвищити складність обслуговування. Важливо обирати тільки ті плагіни, які приносять реальну користь і активно підтримуються.

5. **Q:** *Що робити, якщо налаштування плагіна ламає мої тести?*  
   **A:** Перевірте документацію до плагіна, перегляньте наявність конфліктів із поточними налаштуваннями й спробуйте ізолювати плагін у невеликому тесті для пошуку причини. Також рекомендується централізовано й акуратно документувати всі конфігурації плагінів.
